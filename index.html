<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IntegraProjetos — Rede de Integração</title>
  <meta name="theme-color" content="#0b1220"/>
  <style>
    :root{
      --bg:#0b1220;
      --panel:rgba(15,26,46,.78);
      --card:rgba(16,28,51,.62);
      --stroke:rgba(255,255,255,.10);
      --stroke2:rgba(255,255,255,.20);
      --txt:#e5e7eb;
      --muted:#a9b4c2;
      --shadow: 0 18px 45px rgba(0,0,0,.35);
      --radius: 18px;
      --purple:rgba(124,58,237,.95);
      --green:rgba(34,197,94,.95);
      --orange:rgba(245,158,11,.95);
      --blue:rgba(96,165,250,.95);
      --red:rgba(239,68,68,.90);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(1200px 700px at 15% 10%, rgba(124,58,237,.22), transparent 55%),
        radial-gradient(900px 600px at 85% 20%, rgba(34,197,94,.15), transparent 55%),
        radial-gradient(900px 600px at 50% 85%, rgba(245,158,11,.10), transparent 60%),
        var(--bg);
      color:var(--txt);
      overflow:hidden;
    }

    .topbar{
      position:fixed; inset:12px 12px auto 12px;
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      background:var(--panel);
      border:1px solid var(--stroke);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding:10px 12px;
      box-shadow: var(--shadow);
      z-index:80;
      flex-wrap:wrap;
    }
    .brand{display:flex; align-items:center; gap:10px; min-width:260px}
    .logo{
      width:36px; height:36px; border-radius:12px;
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,.28), transparent 55%),
        linear-gradient(135deg, rgba(124,58,237,.95), rgba(34,197,94,.85));
      display:grid; place-items:center;
      border:1px solid rgba(255,255,255,.15);
      user-select:none;
    }
    .brand h1{font-size:14px; margin:0}
    .brand p{margin:0; font-size:12px; color:var(--muted)}

    .actions{display:flex; gap:8px; flex-wrap:wrap; align-items:center}

    button{
      appearance:none;
      border:1px solid var(--stroke);
      background:rgba(16,28,51,.70);
      color:var(--txt);
      border-radius:12px;
      padding:9px 10px;
      font-weight:750;
      font-size:12px;
      cursor:pointer;
      transition: transform .05s ease, border-color .2s ease, background .2s ease;
      user-select:none;
      white-space:nowrap;
    }
    button:hover{border-color:var(--stroke2)}
    button:active{transform: translateY(1px)}
    button:disabled{opacity:.55; cursor:not-allowed}

    .btn-primary{
      background: linear-gradient(135deg, rgba(124,58,237,.92), rgba(34,197,94,.72));
      border-color: rgba(255,255,255,.18);
    }
    .btn-danger{ border-color: rgba(239,68,68,.35); background: rgba(239,68,68,.10); }
    .btn-warn{ border-color: rgba(245,158,11,.35); background: rgba(245,158,11,.10); }

    .status{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background:rgba(16,28,51,.45);
      color:rgba(229,231,235,.85);
      font-size:12px;
      user-select:none;
    }
    .dot{ width:10px; height:10px; border-radius:999px; border:1px solid rgba(255,255,255,.18); }

    /* STAGE */
    #stage{
      position:fixed;
      inset: 78px 12px 12px 12px;
      border-radius: 18px;
      border:1px solid var(--stroke);
      background: rgba(8,14,26,.35);
      box-shadow: var(--shadow);
      overflow:hidden;
      z-index:10;
    }
    #svg{ width:100%; height:100%; display:block; }

    /* Legend overlay */
    .legend{
      position:absolute; left:12px; bottom:12px;
      display:flex; gap:8px; flex-wrap:wrap;
      z-index:20;
      pointer-events:none;
    }
    .tag{
      display:inline-flex; align-items:center; gap:8px;
      padding:7px 9px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(15,26,46,.62);
      font-size:12px;
      color:var(--muted);
      backdrop-filter: blur(8px);
    }

    /* PANEL (drawer) */
    .drawer{
      position:fixed;
      left:12px; right:12px;
      bottom:12px;
      height: 52vh;
      border-radius: 18px;
      border:1px solid var(--stroke);
      background: var(--panel);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      overflow:hidden;
      z-index:70;
      display:flex;
      flex-direction:column;
      transform: translateY(0);
      transition: transform .18s ease;
    }
    .drawer.collapsed{ transform: translateY(calc(52vh - 64px)); }

    .drawer header{
      padding:10px 12px;
      border-bottom:1px solid var(--stroke);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background: rgba(15,26,46,.86);
    }
    .drawer header .left{
      display:flex; flex-direction:column;
    }
    .drawer header h2{margin:0; font-size:13px}
    .drawer header .small{font-size:12px; color:var(--muted); margin-top:2px}

    .drawer .toolbar{
      padding:10px 12px;
      border-bottom:1px solid var(--stroke);
      display:flex; gap:8px; flex-wrap:wrap;
      background: rgba(15,26,46,.86);
    }
    .drawer .content{
      padding:12px;
      overflow:auto;
      flex:1;
    }
    .pill{
      display:inline-flex; gap:6px; align-items:center;
      border:1px solid var(--stroke);
      background:rgba(16,28,51,.55);
      padding:6px 8px; border-radius:999px; font-size:12px; color:var(--muted);
      white-space:nowrap;
    }
    .mini{
      border:1px solid var(--stroke);
      background: rgba(16,28,51,.45);
      border-radius: 14px;
      padding:10px;
    }
    .mini b{display:block; font-size:13px; margin-bottom:4px}
    .mini .meta{font-size:12px; color:var(--muted)}
    .actions2{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
    .grid{display:grid; gap:10px}
    .sep{height:1px; background:var(--stroke); margin:10px 0}
    .hint{font-size:12px; color:var(--muted); line-height:1.35}
    .row{display:flex; gap:8px}
    .row > *{flex:1}

    input[type="text"], textarea, select{
      width:100%;
      border-radius: 12px;
      border:1px solid var(--stroke);
      background: rgba(16,28,51,.65);
      color: var(--txt);
      padding:10px 10px;
      outline:none;
      font-size:13px;
    }
    textarea{min-height:72px; resize: vertical;}

    /* MODAL */
    .modal{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      place-items:center;
      z-index:120;
      padding:12px;
    }
    .modal[open]{display:grid}
    .box{
      width:min(860px, calc(100vw - 24px));
      max-height: min(90vh, 940px);
      overflow:auto;
      border-radius: 18px;
      border:1px solid var(--stroke);
      background: rgba(15,26,46,.92);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      padding:12px;
    }
    .box header{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:6px 6px 10px;
      border-bottom:1px solid var(--stroke);
    }
    .box header h3{margin:0; font-size:14px}
    .box .body{padding:10px 6px 6px}

    /* Desktop: drawer vira sidebar */
    @media (min-width: 980px){
      #stage{ inset:78px 430px 12px 12px; }
      .drawer{
        top:78px; right:12px; left:auto; bottom:12px;
        width:410px; height:auto;
        transform:none !important;
      }
    }
  </style>
</head>
<body>

  <div class="topbar">
    <div class="brand">
      <div class="logo">●</div>
      <div>
        <h1>IntegraProjetos — Rede visual de integração</h1>
        <p>Arraste bolinhas • toque para ver • crie ligações escolhendo origem e destino</p>
      </div>
    </div>

    <div class="actions">
      <button class="btn-primary" id="btnAdd">+ Adicionar pessoa</button>
      <button id="btnAddLink">+ Criar ligação</button>
      <button id="btnCenter">Centralizar</button>
      <button id="btnZoomIn">Zoom +</button>
      <button id="btnZoomOut">Zoom -</button>
      <button id="btnAuto">Auto-organizar</button>
      <button id="btnAnim">Animar: ON</button>
      <button id="btnExportJson">Baixar JSON</button>
      <button class="btn-warn" id="btnImport">Importar JSON</button>

      <span class="status" id="saveStatus" title="Se ficar vermelho, o navegador bloqueou o armazenamento">
        <span class="dot" id="saveDot" style="background:rgba(34,197,94,.95)"></span>
        <span id="saveText">Salvo ✓</span>
      </span>

      <button class="btn-danger" id="btnResetClean">Reset limpo</button>
      <button class="btn-danger" id="btnResetSeed">Reset modelo</button>
      <button id="btnTogglePanel">Mostrar rede</button>
    </div>
  </div>

  <div id="stage">
    <svg id="svg" viewBox="0 0 1200 800" preserveAspectRatio="none"></svg>

    <div class="legend" aria-hidden="true">
      <span class="tag"><span class="dot" style="background:var(--purple)"></span>Dados/integração</span>
      <span class="tag"><span class="dot" style="background:var(--green)"></span>Produto/jogo</span>
      <span class="tag"><span class="dot" style="background:var(--orange)"></span>Extensão/visibilidade</span>
      <span class="tag"><span class="dot" style="background:var(--blue)"></span>Análise científica</span>
    </div>
  </div>

  <aside class="drawer" id="drawer">
    <header>
      <div class="left">
        <h2 id="sideTitle">Gerenciar pessoas</h2>
        <div class="small" id="sideSub">Toque numa pessoa para abrir. No mobile: use “Mostrar rede” se a rede sumir.</div>
      </div>
      <span class="pill" id="countPill">0 pessoas</span>
    </header>

    <div class="toolbar">
      <button id="tbOpen" disabled>Abrir</button>
      <button id="tbEdit" disabled>Editar</button>
      <button id="tbDelete" class="btn-danger" disabled>Excluir</button>
      <button id="tbLink" disabled>Criar ligação</button>
      <button id="tbFocus" disabled>Focar</button>
      <button id="tbBack">Voltar p/ lista</button>
    </div>

    <div class="content" id="sideContent"></div>
  </aside>

  <!-- Modal Pessoa -->
  <div class="modal" id="modalPerson">
    <div class="box">
      <header>
        <h3 id="modalPersonTitle">Adicionar pessoa</h3>
        <div style="display:flex; gap:8px">
          <button id="btnClosePerson">Fechar</button>
          <button class="btn-primary" id="btnSavePerson">Salvar</button>
        </div>
      </header>
      <div class="body">
        <div class="grid">
          <div class="row">
            <div>
              <div class="hint">Nome</div>
              <input type="text" id="p_name" placeholder="Ex.: Letícia Zen" />
            </div>
            <div>
              <div class="hint">Nível</div>
              <select id="p_level">
                <option>Graduação</option>
                <option>Mestrado</option>
                <option>Doutorado</option>
                <option>Pós-doutorado</option>
                <option>Professor</option>
                <option>Colaborador</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div>
              <div class="hint">Área</div>
              <input type="text" id="p_area" placeholder="Ex.: Clima & Saúde" />
            </div>
            <div>
              <div class="hint">Cor da bolinha (opcional)</div>
              <input type="text" id="p_color" placeholder="Ex.: #22c55e ou rgba(...)" />
            </div>
          </div>

          <div>
            <div class="hint">Título do trabalho</div>
            <input type="text" id="p_title" />
          </div>

          <div>
            <div class="hint">Objetivos</div>
            <textarea id="p_objectives"></textarea>
          </div>

          <div>
            <div class="hint">Resultados esperados</div>
            <textarea id="p_expected"></textarea>
          </div>

          <div>
            <div class="hint">Tags (vírgula)</div>
            <input type="text" id="p_tags" placeholder="planilhas, gráficos, carbono..." />
          </div>

          <div class="hint">
            Se o teu navegador bloquear salvamento, o indicador vai ficar vermelho — aí use “Baixar JSON” e “Importar JSON”.
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Ligação -->
  <div class="modal" id="modalLink">
    <div class="box">
      <header>
        <h3 id="modalLinkTitle">Criar ligação</h3>
        <div style="display:flex; gap:8px">
          <button id="btnCloseLink">Fechar</button>
          <button class="btn-primary" id="btnSaveLink">Salvar ligação</button>
        </div>
      </header>
      <div class="body">
        <div class="grid">
          <div class="row">
            <div>
              <div class="hint">Origem</div>
              <select id="l_from"></select>
            </div>
            <div>
              <div class="hint">Destino</div>
              <select id="l_to"></select>
            </div>
          </div>

          <div class="row">
            <div>
              <div class="hint">Tipo</div>
              <select id="l_type">
                <option value="dados">Dados / Integração</option>
                <option value="analise">Análise científica</option>
                <option value="extensao">Extensão / Visibilidade</option>
                <option value="produto">Produto / Jogo</option>
                <option value="campo">Coleta / Campo</option>
                <option value="outro">Outro</option>
              </select>
            </div>
            <div>
              <div class="hint">Intensidade</div>
              <select id="l_weight">
                <option>1</option><option>2</option><option selected>3</option><option>4</option><option>5</option>
              </select>
            </div>
          </div>

          <div>
            <div class="hint">Por que liga?</div>
            <textarea id="l_reason"></textarea>
          </div>
          <div>
            <div class="hint">Perguntas</div>
            <textarea id="l_questions"></textarea>
          </div>
          <div>
            <div class="hint">Resultados esperados da ligação</div>
            <textarea id="l_outputs"></textarea>
          </div>
        </div>
      </div>
    </div>
  </div>

  <input type="file" id="fileImport" accept="application/json" style="display:none"/>

<script>
/* =========================
   IntegraProjetos v3
   - Sem onclick inline (Android para de falhar)
   - Drawer colapsável (rede sempre visível)
   - Zoom / Centralizar
   - Persistência com aviso se storage bloqueado
========================= */
const STORAGE_KEY = "integraprojetos_v3";

function uid(){ return "id_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16); }
function deepClone(o){ return JSON.parse(JSON.stringify(o)); }
function escapeHTML(s){
  return String(s ?? "")
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}
function clamp(v,a,b){ return Math.max(a, Math.min(b,v)); }

function linkColor(type){
  switch(type){
    case "dados": return "rgba(124,58,237,.95)";
    case "produto": return "rgba(34,197,94,.95)";
    case "extensao": return "rgba(245,158,11,.95)";
    case "analise": return "rgba(96,165,250,.95)";
    case "campo": return "rgba(239,68,68,.85)";
    default: return "rgba(229,231,235,.30)";
  }
}
function shortType(type){
  switch(type){
    case "dados": return "dados";
    case "produto": return "produto";
    case "extensao": return "extensão";
    case "analise": return "análise";
    case "campo": return "campo";
    default: return "outro";
  }
}
function downloadBlob(text, filename, mime){
  const blob = new Blob([text], {type:mime});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = filename;
  document.body.appendChild(a);
  a.click(); a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 800);
}

/* ==== Seed: seus 7 alunos (sem ligações) ==== */
const SEED = {
  meta:{ app:"IntegraProjetos", version:3, updatedAt:new Date().toISOString() },
  nodes: [
    { id: uid(), name:"Letícia Zen", level:"Graduação", area:"Clima & Saúde",
      title:"Impacto do calor na mortalidade em MT (dados secundários)",
      objectives:"Trabalha com análise de dados secundários sobre o impacto do calor na mortalidade em MT.",
      expected:"Organização de planilhas e produção de gráficos comparativos e analíticos.",
      tags:["mortalidade","calor","planilhas","gráficos","MT"], color:"rgba(96,165,250,.95)"
    },
    { id: uid(), name:"Cintya", level:"Graduação", area:"Extensão & Visibilidade",
      title:"Extensão na pós: visibilidade e identificação de projetos",
      objectives:"Produção de dados sobre a extensão na pós-graduação, com análise e identificação de projetos para dar visibilidade à pós-graduação.",
      expected:"Identificação de projetos para a visibilidade da pós da UNEMAT.",
      tags:["extensão","pós-graduação","visibilidade","mapeamento"], color:"rgba(245,158,11,.95)"
    },
    { id: uid(), name:"Antônio", level:"Graduação", area:"Atividade Física & Ambiente",
      title:"Efeito da temperatura em atividade física (aberto/fechado/escolas)",
      objectives:"Avalia o efeito da temperatura em atividades físicas de áreas abertas, fechadas e em escolas.",
      expected:"Coleta de dados em diferentes ambientes em Cáceres; organização de planilhas; análises e comparações térmicas entre ambientes.",
      tags:["temperatura","atividade física","Cáceres","campo","comparação"], color:"rgba(34,197,94,.95)"
    },
    { id: uid(), name:"Luan", level:"Graduação", area:"Jogos & Educação",
      title:"Jogo interativo sobre carbono (rumo ao 3D)",
      objectives:"Produção de jogos interativos sobre o carbono; analisa itens necessários para produção do jogo.",
      expected:"Produzir um jogo 3D sobre carbono.",
      tags:["jogos","carbono","3D","educação"], color:"rgba(124,58,237,.95)"
    },
    { id: uid(), name:"Matheus", level:"Graduação", area:"Carbono (dados)",
      title:"Inspetor/organizador de planilhas do laboratório (carbono)",
      objectives:"Organização de dados de carbono em planilhas; atua como inspetor de dados e integração de planilhas do lab.",
      expected:"Todas as planilhas deverão ser revisadas por ele para integração de dados.",
      tags:["planilhas","carbono","integração","qualidade"], color:"rgba(16,185,129,.95)"
    },
    { id: uid(), name:"Leandro", level:"Graduação", area:"Carbono (processos)",
      title:"ATTZ e dinâmica do carbono na praia de Cáceres",
      objectives:"Analisa a influência da ATTZ na dinâmica do carbono em praia de Cáceres.",
      expected:"Identificar a dinâmica das águas e sua influência no fluxo de CO₂ de áreas alagáveis até secas.",
      tags:["ATTZ","CO2","hidrodinâmica","Cáceres","alagável"], color:"rgba(59,130,246,.95)"
    },
    { id: uid(), name:"Vanessa", level:"Graduação", area:"Jogos & Educação",
      title:"Jogos físicos + Guardiões do Clima (ensino médio)",
      objectives:"Produção de jogos físicos para integração com estudantes do ensino médio; monitora dos Guardiões do Clima.",
      expected:"Produzir jogos sobre carbono e mudanças climáticas para crianças e adolescentes.",
      tags:["jogos físicos","ensino médio","clima","carbono"], color:"rgba(236,72,153,.92)"
    }
  ],
  links:[]
};

/* ==== DOM ==== */
const svg = document.getElementById("svg");
const stage = document.getElementById("stage");

const drawer = document.getElementById("drawer");
const btnTogglePanel = document.getElementById("btnTogglePanel");

const countPill = document.getElementById("countPill");
const sideTitle = document.getElementById("sideTitle");
const sideSub = document.getElementById("sideSub");
const sideContent = document.getElementById("sideContent");

const saveDot = document.getElementById("saveDot");
const saveText = document.getElementById("saveText");

const modalPerson = document.getElementById("modalPerson");
const modalLink = document.getElementById("modalLink");

const p_name = document.getElementById("p_name");
const p_level = document.getElementById("p_level");
const p_area = document.getElementById("p_area");
const p_color = document.getElementById("p_color");
const p_title = document.getElementById("p_title");
const p_objectives = document.getElementById("p_objectives");
const p_expected = document.getElementById("p_expected");
const p_tags = document.getElementById("p_tags");

const l_from = document.getElementById("l_from");
const l_to = document.getElementById("l_to");
const l_type = document.getElementById("l_type");
const l_weight = document.getElementById("l_weight");
const l_reason = document.getElementById("l_reason");
const l_questions = document.getElementById("l_questions");
const l_outputs = document.getElementById("l_outputs");

const fileImport = document.getElementById("fileImport");

/* toolbar drawer */
const tbOpen = document.getElementById("tbOpen");
const tbEdit = document.getElementById("tbEdit");
const tbDelete = document.getElementById("tbDelete");
const tbLink = document.getElementById("tbLink");
const tbFocus = document.getElementById("tbFocus");
const tbBack = document.getElementById("tbBack");

/* top buttons */
document.getElementById("btnAdd").addEventListener("click", ()=> openPersonModal(null));
document.getElementById("btnAddLink").addEventListener("click", ()=> openLinkModal(null));
document.getElementById("btnAuto").addEventListener("click", ()=> { autoOrganize(true); persist(); centerNow(); });
document.getElementById("btnAnim").addEventListener("click", ()=> toggleAnim());
document.getElementById("btnExportJson").addEventListener("click", exportJSON);
document.getElementById("btnImport").addEventListener("click", ()=> fileImport.click());
document.getElementById("btnResetClean").addEventListener("click", resetClean);
document.getElementById("btnResetSeed").addEventListener("click", resetSeed);

document.getElementById("btnCenter").addEventListener("click", ()=> centerNow());
document.getElementById("btnZoomIn").addEventListener("click", ()=> setZoom(zoom*1.12));
document.getElementById("btnZoomOut").addEventListener("click", ()=> setZoom(zoom/1.12));

btnTogglePanel.addEventListener("click", ()=> toggleDrawer());

document.getElementById("btnClosePerson").addEventListener("click", ()=> closeModal(modalPerson));
document.getElementById("btnSavePerson").addEventListener("click", savePersonFromModal);

document.getElementById("btnCloseLink").addEventListener("click", ()=> closeModal(modalLink));
document.getElementById("btnSaveLink").addEventListener("click", saveLinkFromModal);

fileImport.addEventListener("change", importJSONFile);

/* toolbar actions */
tbOpen.addEventListener("click", ()=> { if(selectedNodeId) openDetails(selectedNodeId); });
tbEdit.addEventListener("click", ()=> { if(selectedNodeId) openPersonModal(selectedNodeId); });
tbDelete.addEventListener("click", ()=> { if(selectedNodeId) deletePerson(selectedNodeId); });
tbLink.addEventListener("click", ()=> { if(selectedNodeId) openLinkModal(null, selectedNodeId); });
tbFocus.addEventListener("click", ()=> { if(selectedNodeId) focusNode(selectedNodeId); });
tbBack.addEventListener("click", ()=> { selectedNodeId = null; renderAll(); });

/* ==== SVG layers ==== */
function makeSvg(tag, attrs={}){
  const el = document.createElementNS("http://www.w3.org/2000/svg", tag);
  for(const [k,v] of Object.entries(attrs)) el.setAttribute(k, v);
  return el;
}
const gRoot = makeSvg("g", { id:"gRoot" });
const gLinks = makeSvg("g", { id:"gLinks" });
const gNodes = makeSvg("g", { id:"gNodes" });
gRoot.appendChild(gLinks);
gRoot.appendChild(gNodes);
svg.appendChild(gRoot);

/* ==== State ==== */
let state = loadState();
let selectedNodeId = null;
let editingPersonId = null;
let editingLinkId = null;

let view = { w:1200, h:800 };
let animOn = true;
let dragging = null;

let zoom = 1.0;
let pan = { x:0, y:0 };

resizeSVG();
window.addEventListener("resize", ()=> { resizeSVG(); renderGraph(); });

initPositionsIfNeeded();
autoOrganize(false);
centerNow();
startSim();
renderAll();

/* ==== persistence ==== */
function loadState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return deepClone(SEED);
    const obj = JSON.parse(raw);
    return normalize(obj);
  }catch(e){
    return deepClone(SEED);
  }
}
function normalize(obj){
  return {
    meta: obj.meta || { app:"IntegraProjetos", version:3, updatedAt:new Date().toISOString() },
    nodes: (obj.nodes||[]).map(n=>({
      id: n.id || uid(),
      name: n.name || "Sem nome",
      level: n.level || "Graduação",
      area: n.area || "",
      title: n.title || "",
      objectives: n.objectives || "",
      expected: n.expected || "",
      tags: Array.isArray(n.tags)? n.tags : [],
      color: n.color || "rgba(124,58,237,.95)",
      x: Number.isFinite(n.x)? n.x : 0,
      y: Number.isFinite(n.y)? n.y : 0,
      vx: Number.isFinite(n.vx)? n.vx : 0,
      vy: Number.isFinite(n.vy)? n.vy : 0,
      fx: null, fy: null
    })),
    links: (obj.links||[]).map(l=>({
      id: l.id || uid(),
      from: l.from, to: l.to,
      type: l.type || "dados",
      weight: Number(l.weight||3),
      reason: l.reason || "",
      questions: l.questions || "",
      outputs: l.outputs || ""
    }))
  };
}
function persist(){
  try{
    state.meta.updatedAt = new Date().toISOString();
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    setSaved(true);
  }catch(e){
    // storage bloqueado -> avisa vermelho
    setSaved(false, "Storage bloqueado — use Baixar JSON");
  }
}
let saveTimer=null;
function setSaved(ok, msg){
  if(saveTimer) clearTimeout(saveTimer);
  if(ok){
    saveDot.style.background = "rgba(34,197,94,.95)";
    saveText.textContent = msg || "Salvo ✓";
  }else{
    saveDot.style.background = "rgba(239,68,68,.90)";
    saveText.textContent = msg || "Não salvou";
  }
  saveTimer = setTimeout(()=>{
    if(ok){
      saveDot.style.background = "rgba(34,197,94,.95)";
      saveText.textContent = "Salvo ✓";
    }
  }, 2500);
}

/* ==== helpers ==== */
function getNode(id){ return state.nodes.find(n=>n.id===id); }

function initPositionsIfNeeded(){
  state.nodes.forEach(n=>{
    const bad = !Number.isFinite(n.x) || !Number.isFinite(n.y) || (n.x===0 && n.y===0);
    if(bad){
      n.x = view.w/2 + (Math.random()-.5)*420;
      n.y = view.h/2 + (Math.random()-.5)*320;
      n.vx = (Math.random()-.5)*2;
      n.vy = (Math.random()-.5)*2;
    }
  });
}
function resizeSVG(){
  const rect = stage.getBoundingClientRect();
  view.w = Math.max(700, Math.floor(rect.width));
  view.h = Math.max(520, Math.floor(rect.height));
  svg.setAttribute("viewBox", `0 0 ${view.w} ${view.h}`);
}

/* ==== Drawer ==== */
function toggleDrawer(force){
  if(typeof force === "boolean"){
    drawer.classList.toggle("collapsed", force);
  }else{
    drawer.classList.toggle("collapsed");
  }
  const collapsed = drawer.classList.contains("collapsed");
  btnTogglePanel.textContent = collapsed ? "Mostrar painel" : "Mostrar rede";
}

/* ==== Rendering ==== */
function renderAll(){
  countPill.textContent = `${state.nodes.length} pessoas`;
  renderSide();
  renderGraph();
  updateToolbar();
}

function updateToolbar(){
  const has = !!selectedNodeId && !!getNode(selectedNodeId);
  tbOpen.disabled = !has;
  tbEdit.disabled = !has;
  tbDelete.disabled = !has;
  tbLink.disabled = !has;
  tbFocus.disabled = !has;
}

function renderSide(){
  if(!selectedNodeId){
    sideTitle.textContent = "Gerenciar pessoas";
    sideSub.textContent = "Toque em “Abrir” na pessoa. Se a rede sumir, toque “Mostrar rede”.";
    sideContent.innerHTML = `
      <div class="hint">
        Lista com botões reais (sem bug de Android). Você sempre consegue abrir/editar/excluir.
      </div>
      <div class="sep"></div>
      <div class="grid" id="peopleList"></div>
    `;
    const list = document.getElementById("peopleList");
    const sorted = [...state.nodes].sort((a,b)=>a.name.localeCompare(b.name,"pt-BR"));
    sorted.forEach(n=>{
      const box = document.createElement("div");
      box.className = "mini";
      box.innerHTML = `
        <b>${escapeHTML(n.name)}</b>
        <div class="meta">${escapeHTML(n.level)} • ${escapeHTML(n.area)}</div>
        <div class="meta" style="margin-top:6px">${escapeHTML(n.title||"")}</div>
        <div class="actions2">
          <button data-act="open">Abrir</button>
          <button data-act="focus">Focar</button>
          <button data-act="edit">Editar</button>
          <button class="btn-danger" data-act="del">Excluir</button>
        </div>
      `;
      box.querySelector('[data-act="open"]').addEventListener("click", ()=>{
        selectedNodeId = n.id; openDetails(n.id);
      });
      box.querySelector('[data-act="focus"]').addEventListener("click", ()=> focusNode(n.id));
      box.querySelector('[data-act="edit"]').addEventListener("click", ()=> openPersonModal(n.id));
      box.querySelector('[data-act="del"]').addEventListener("click", ()=> deletePerson(n.id));
      list.appendChild(box);
    });
    return;
  }
  openDetails(selectedNodeId);
}

function openDetails(id){
  const n = getNode(id);
  if(!n){ selectedNodeId=null; renderAll(); return; }

  sideTitle.textContent = n.name;
  sideSub.textContent = `${n.level} • ${n.area}`;

  const rel = state.links.filter(l => l.from===n.id || l.to===n.id);

  sideContent.innerHTML = `
    <div class="grid">
      <div class="mini">
        <b>${escapeHTML(n.title || "Sem título")}</b>
        <div class="meta">${escapeHTML(n.level)} • ${escapeHTML(n.area)}</div>
      </div>

      <div class="mini">
        <div class="meta">Objetivos</div>
        <div style="white-space:pre-wrap; margin-top:6px">${escapeHTML(n.objectives||"")}</div>
      </div>

      <div class="mini">
        <div class="meta">Resultados esperados</div>
        <div style="white-space:pre-wrap; margin-top:6px">${escapeHTML(n.expected||"")}</div>
      </div>

      <div class="mini">
        <div class="meta">Tags</div>
        <div style="margin-top:8px; display:flex; gap:6px; flex-wrap:wrap">
          ${(n.tags||[]).map(t=>`<span class="pill">${escapeHTML(t)}</span>`).join("") || `<span class="hint">Sem tags.</span>`}
        </div>
      </div>

      <div class="mini">
        <b>Ligações (${rel.length})</b>
        <div class="hint" style="margin-top:4px">Use “Criar ligação” e escolha origem/destino.</div>
        <div class="sep"></div>
        <div class="grid" id="relList"></div>
      </div>
    </div>
  `;

  const relList = document.getElementById("relList");
  rel.forEach(l=>{
    const otherId = (l.from===n.id) ? l.to : l.from;
    const other = getNode(otherId);
    const box = document.createElement("div");
    box.className = "mini";
    box.innerHTML = `
      <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:10px">
        <div>
          <b>${escapeHTML(other ? other.name : "—")}</b>
          <div class="meta">${escapeHTML(shortType(l.type))} • intensidade ${escapeHTML(String(l.weight||3))}</div>
        </div>
        <span class="pill" style="border-color:${linkColor(l.type)}; color:rgba(229,231,235,.88)">${escapeHTML(shortType(l.type))}</span>
      </div>
      <div class="meta" style="margin-top:10px">Por quê</div>
      <div style="white-space:pre-wrap; margin-top:4px">${escapeHTML(l.reason||"")}</div>
      <div class="actions2">
        <button data-act="edit">Editar ligação</button>
        <button class="btn-danger" data-act="del">Excluir ligação</button>
      </div>
    `;
    box.querySelector('[data-act="edit"]').addEventListener("click", ()=> openLinkModal(l.id));
    box.querySelector('[data-act="del"]').addEventListener("click", ()=> deleteLink(l.id));
    relList.appendChild(box);
  });

  updateToolbar();
  renderGraph();
  focusNode(id);
}

/* ==== Graph render (com pan/zoom) ==== */
function renderGraph(){
  gLinks.innerHTML = "";
  gNodes.innerHTML = "";

  gRoot.setAttribute("transform", `translate(${pan.x} ${pan.y}) scale(${zoom})`);

  state.links.forEach(link=>{
    const a = getNode(link.from);
    const b = getNode(link.to);
    if(!a || !b) return;

    const line = makeSvg("line", {
      x1:a.x, y1:a.y, x2:b.x, y2:b.y,
      stroke: linkColor(link.type),
      "stroke-width": Math.max(2.0, Number(link.weight||3) * 1.5),
      "stroke-opacity": selectedNodeId ? ((link.from===selectedNodeId || link.to===selectedNodeId) ? .90 : .20) : .55
    });
    line.style.cursor = "pointer";
    line.addEventListener("click", (e)=>{ e.stopPropagation(); openLinkModal(link.id); });
    gLinks.appendChild(line);

    const mx=(a.x+b.x)/2, my=(a.y+b.y)/2;
    const t = makeSvg("text", {
      x:mx, y:my-6,
      fill:"rgba(229,231,235,.78)",
      "font-size":"12",
      "text-anchor":"middle"
    });
    t.textContent = shortType(link.type);
    t.style.pointerEvents = "none";
    gLinks.appendChild(t);
  });

  state.nodes.forEach(node=>{
    const base = 22;
    const r = base + Math.min(10, (node.tags||[]).length);
    const isSel = node.id === selectedNodeId;

    const group = makeSvg("g", {"data-id": node.id});
    group.style.cursor = "grab";

    const halo = makeSvg("circle", {
      cx:node.x, cy:node.y, r:r+14,
      fill:"transparent",
      stroke: isSel ? "rgba(255,255,255,.45)" : "rgba(255,255,255,.10)",
      "stroke-width": isSel ? 2.8 : 1.2
    });
    group.appendChild(halo);

    const c = makeSvg("circle", {
      cx:node.x, cy:node.y, r,
      fill: node.color || "rgba(124,58,237,.95)",
      stroke:"rgba(255,255,255,.18)",
      "stroke-width": isSel ? 2.6 : 1.3
    });
    group.appendChild(c);

    const name = makeSvg("text", {
      x: node.x, y: node.y + r + 18,
      fill: isSel ? "rgba(255,255,255,.95)" : "rgba(229,231,235,.82)",
      "font-size":"13",
      "text-anchor":"middle"
    });
    name.textContent = node.name;
    group.appendChild(name);

    const sub = makeSvg("text", {
      x: node.x, y: node.y + r + 34,
      fill:"rgba(169,180,194,.85)",
      "font-size":"11",
      "text-anchor":"middle"
    });
    sub.textContent = node.area;
    group.appendChild(sub);

    group.addEventListener("mousedown", (e)=>startDrag(e,node.id));
    group.addEventListener("touchstart", (e)=>startDrag(e,node.id), {passive:false});
    group.addEventListener("click", (e)=>{
      e.stopPropagation();
      selectedNodeId = node.id;
      renderAll();
      // no mobile, abre painel e foca
      toggleDrawer(false);
      focusNode(node.id);
    });

    gNodes.appendChild(group);
  });

  // clique no fundo limpa seleção
  svg.onclick = ()=> { selectedNodeId = null; renderAll(); };
}

/* ==== Pan/Zoom ==== */
function setZoom(z){
  zoom = clamp(z, 0.55, 1.9);
  renderGraph();
}
function centerNow(){
  pan.x = 0; pan.y = 0;
  // centraliza o “bbox” da rede no meio do stage
  if(state.nodes.length){
    let minX=Infinity, minY=Infinity, maxX=-Infinity, maxY=-Infinity;
    state.nodes.forEach(n=>{
      minX=Math.min(minX,n.x); minY=Math.min(minY,n.y);
      maxX=Math.max(maxX,n.x); maxY=Math.max(maxY,n.y);
    });
    const bx=(minX+maxX)/2, by=(minY+maxY)/2;
    const cx=view.w/2, cy=view.h/2;
    pan.x = (cx - bx) * zoom;
    pan.y = (cy - by) * zoom;
  }
  renderGraph();
}
function focusNode(id){
  const n = getNode(id); if(!n) return;
  const cx=view.w/2, cy=view.h/2;
  pan.x = (cx - n.x) * zoom;
  pan.y = (cy - n.y) * zoom;
  persist();
  renderGraph();
}

/* ==== Drag ==== */
function getPointer(ev){
  const rect = svg.getBoundingClientRect();
  const isTouch = ev.touches && ev.touches[0];
  const clientX = isTouch ? ev.touches[0].clientX : ev.clientX;
  const clientY = isTouch ? ev.touches[0].clientY : ev.clientY;
  const x = (clientX - rect.left) * (view.w / rect.width);
  const y = (clientY - rect.top) * (view.h / rect.height);
  // ajustar para pan/zoom
  const gx = (x - pan.x/zoom);
  const gy = (y - pan.y/zoom);
  return {x: gx, y: gy};
}
function startDrag(ev, nodeId){
  ev.preventDefault();
  const n = getNode(nodeId); if(!n) return;
  dragging = { id:nodeId };
  n.fx = n.x; n.fy = n.y;

  window.addEventListener("mousemove", onDragMove);
  window.addEventListener("mouseup", onDragEnd);
  window.addEventListener("touchmove", onDragMove, {passive:false});
  window.addEventListener("touchend", onDragEnd);
}
function onDragMove(ev){
  if(!dragging) return;
  ev.preventDefault();
  const pt = getPointer(ev);
  const n = getNode(dragging.id); if(!n) return;
  n.fx = clamp(pt.x, 30, view.w-30);
  n.fy = clamp(pt.y, 30, view.h-30);
  renderGraph();
}
function onDragEnd(){
  if(!dragging) return;
  const n = getNode(dragging.id);
  if(n){
    n.x = n.fx; n.y = n.fy;
    n.fx = null; n.fy = null;
    persist();
  }
  dragging = null;
  window.removeEventListener("mousemove", onDragMove);
  window.removeEventListener("mouseup", onDragEnd);
  window.removeEventListener("touchmove", onDragMove);
  window.removeEventListener("touchend", onDragEnd);
}

/* ==== Simulation ==== */
let sim=null;
function startSim(){
  if(sim) cancelAnimationFrame(sim);
  const step = ()=>{
    if(animOn) tick();
    renderGraph();
    sim = requestAnimationFrame(step);
  };
  sim = requestAnimationFrame(step);
}
function tick(){
  const repel = 15000;
  const linkK = 0.012;
  const centerPull = 0.0026;
  const damping = 0.90;

  for(let i=0;i<state.nodes.length;i++){
    for(let j=i+1;j<state.nodes.length;j++){
      const a=state.nodes[i], b=state.nodes[j];
      const dx=a.x-b.x, dy=a.y-b.y;
      let d2=dx*dx+dy*dy; if(d2<0.01) d2=0.01;
      const d=Math.sqrt(d2);
      const f=repel/d2;
      const fx=(dx/d)*f, fy=(dy/d)*f;
      if(a.fx==null){ a.vx += fx; a.vy += fy; }
      if(b.fx==null){ b.vx -= fx; b.vy -= fy; }
    }
  }

  state.links.forEach(l=>{
    const a=getNode(l.from), b=getNode(l.to);
    if(!a||!b) return;
    const dx=b.x-a.x, dy=b.y-a.y;
    const dist=Math.sqrt(dx*dx+dy*dy)||1;
    const target=240 - (Number(l.weight||3)-3)*25;
    const k=linkK*Number(l.weight||3);
    const diff=(dist-target);
    const fx=(dx/dist)*diff*k;
    const fy=(dy/dist)*diff*k;
    if(a.fx==null){ a.vx += fx; a.vy += fy; }
    if(b.fx==null){ b.vx -= fx; b.vy -= fy; }
  });

  const cx=view.w/2, cy=view.h/2;
  state.nodes.forEach(n=>{
    if(n.fx!=null && n.fy!=null){
      n.x=n.fx; n.y=n.fy;
      n.vx*=0.25; n.vy*=0.25;
      return;
    }
    n.vx += (cx-n.x)*centerPull;
    n.vy += (cy-n.y)*centerPull;
    n.vx *= damping; n.vy *= damping;
    n.x = clamp(n.x + n.vx, 30, view.w-30);
    n.y = clamp(n.y + n.vy, 30, view.h-30);
  });
}

/* ==== Auto-organize ==== */
function autoOrganize(force){
  if(state.nodes.length<=1) return;
  let compact=true;
  for(let i=0;i<state.nodes.length;i++){
    for(let j=i+1;j<state.nodes.length;j++){
      const a=state.nodes[i], b=state.nodes[j];
      const dx=a.x-b.x, dy=a.y-b.y;
      if(dx*dx+dy*dy > 160*160){ compact=false; break; }
    }
    if(!compact) break;
  }
  if(!compact && !force) return;

  const cx=view.w/2, cy=view.h/2;
  const R = Math.min(view.w, view.h)*0.30;
  state.nodes.forEach((n,idx)=>{
    const ang = (idx/state.nodes.length) * Math.PI*2;
    n.x = cx + Math.cos(ang)*R + (Math.random()-.5)*30;
    n.y = cy + Math.sin(ang)*R + (Math.random()-.5)*30;
    n.vx = (Math.random()-.5)*2;
    n.vy = (Math.random()-.5)*2;
  });
}

/* ==== Modals ==== */
function openModal(m){ m.setAttribute("open",""); }
function closeModal(m){ m.removeAttribute("open"); }

modalPerson.addEventListener("click", (e)=>{ if(e.target===modalPerson) closeModal(modalPerson); });
modalLink.addEventListener("click", (e)=>{ if(e.target===modalLink) closeModal(modalLink); });

/* ==== Pessoa CRUD ==== */
function openPersonModal(id){
  editingPersonId = id;
  if(id){
    const n=getNode(id);
    document.getElementById("modalPersonTitle").textContent = "Editar pessoa";
    p_name.value = n.name || "";
    p_level.value = n.level || "Graduação";
    p_area.value = n.area || "";
    p_color.value = n.color || "";
    p_title.value = n.title || "";
    p_objectives.value = n.objectives || "";
    p_expected.value = n.expected || "";
    p_tags.value = (n.tags||[]).join(", ");
  }else{
    document.getElementById("modalPersonTitle").textContent = "Adicionar pessoa";
    p_name.value=""; p_level.value="Graduação"; p_area.value=""; p_color.value="";
    p_title.value=""; p_objectives.value=""; p_expected.value=""; p_tags.value="";
  }
  openModal(modalPerson);
}
function savePersonFromModal(){
  const name = p_name.value.trim();
  if(!name){ alert("Informe o nome."); return; }

  const node = {
    id: editingPersonId || uid(),
    name,
    level: p_level.value,
    area: p_area.value.trim(),
    color: p_color.value.trim() || "rgba(124,58,237,.95)",
    title: p_title.value.trim(),
    objectives: p_objectives.value.trim(),
    expected: p_expected.value.trim(),
    tags: p_tags.value.split(",").map(s=>s.trim()).filter(Boolean)
  };

  if(editingPersonId){
    const idx = state.nodes.findIndex(n=>n.id===editingPersonId);
    if(idx>=0){
      const old = state.nodes[idx];
      state.nodes[idx] = {...old, ...node};
    }
  }else{
    node.x = view.w/2 + (Math.random()-.5)*220;
    node.y = view.h/2 + (Math.random()-.5)*160;
    node.vx = (Math.random()-.5)*2;
    node.vy = (Math.random()-.5)*2;
    state.nodes.push(node);
  }

  persist();
  closeModal(modalPerson);

  selectedNodeId = node.id;
  renderAll();
  toggleDrawer(false);
  focusNode(node.id);
}

/* ==== Delete person ==== */
function deletePerson(id){
  const n=getNode(id);
  if(!n) return;
  if(!confirm(`Excluir "${n.name}"? Isso apaga também as ligações.`)) return;
  state.nodes = state.nodes.filter(x=>x.id!==id);
  state.links = state.links.filter(l=>l.from!==id && l.to!==id);
  if(selectedNodeId===id) selectedNodeId=null;
  persist();
  renderAll();
}

/* ==== Link CRUD ==== */
function openLinkModal(linkId, defaultFrom){
  editingLinkId = linkId;

  const nodesSorted = [...state.nodes].sort((a,b)=>a.name.localeCompare(b.name,"pt-BR"));
  l_from.innerHTML = nodesSorted.map(n=>`<option value="${n.id}">${escapeHTML(n.name)}</option>`).join("");
  l_to.innerHTML = nodesSorted.map(n=>`<option value="${n.id}">${escapeHTML(n.name)}</option>`).join("");

  if(linkId){
    const l = state.links.find(x=>x.id===linkId);
    document.getElementById("modalLinkTitle").textContent = "Editar ligação";
    l_from.value = l.from;
    l_to.value = l.to;
    l_type.value = l.type || "dados";
    l_weight.value = String(l.weight||3);
    l_reason.value = l.reason || "";
    l_questions.value = l.questions || "";
    l_outputs.value = l.outputs || "";
  }else{
    document.getElementById("modalLinkTitle").textContent = "Criar ligação";
    const from = defaultFrom || selectedNodeId || (state.nodes[0]?.id);
    const to = state.nodes.find(n=>n.id!==from)?.id || from;
    l_from.value = from;
    l_to.value = to;
    l_type.value = "dados";
    l_weight.value = "3";
    l_reason.value = "";
    l_questions.value = "";
    l_outputs.value = "";
  }

  openModal(modalLink);
}
function saveLinkFromModal(){
  const from = l_from.value;
  const to = l_to.value;
  if(!from || !to || from===to){
    alert("Escolha origem e destino diferentes.");
    return;
  }
  const link = {
    id: editingLinkId || uid(),
    from, to,
    type: l_type.value,
    weight: Number(l_weight.value||3),
    reason: l_reason.value.trim(),
    questions: l_questions.value.trim(),
    outputs: l_outputs.value.trim()
  };

  if(editingLinkId){
    const idx = state.links.findIndex(l=>l.id===editingLinkId);
    if(idx>=0) state.links[idx]=link;
  }else{
    state.links.push(link);
  }
  persist();
  closeModal(modalLink);
  renderAll();
}
function deleteLink(id){
  if(!confirm("Excluir esta ligação?")) return;
  state.links = state.links.filter(l=>l.id!==id);
  persist();
  renderAll();
}

/* ==== Export/Import ==== */
function exportJSON(){
  const out = {
    meta: { app:"IntegraProjetos", version:3, exportedAt:new Date().toISOString() },
    nodes: state.nodes.map(n=>({ ...n, x:Math.round(n.x), y:Math.round(n.y) })),
    links: state.links
  };
  downloadBlob(JSON.stringify(out, null, 2), "integraprojetos.json", "application/json");
}
function importJSONFile(ev){
  const f = ev.target.files[0];
  if(!f) return;
  const reader = new FileReader();
  reader.onload = ()=>{
    try{
      const obj = JSON.parse(reader.result);
      state = normalize(obj);
      initPositionsIfNeeded();
      autoOrganize(true);
      persist();
      selectedNodeId=null;
      renderAll();
      centerNow();
    }catch(e){
      alert("Falha ao importar: " + e.message);
    }finally{
      ev.target.value = "";
    }
  };
  reader.readAsText(f);
}

/* ==== Reset ==== */
function resetClean(){
  if(!confirm("Reset limpo: apagar todas as pessoas e ligações?")) return;
  state = { meta:{ app:"IntegraProjetos", version:3, updatedAt:new Date().toISOString() }, nodes:[], links:[] };
  selectedNodeId=null;
  persist();
  renderAll();
}
function resetSeed(){
  if(!confirm("Reset modelo: voltar para os 7 alunos iniciais (sem ligações)?")) return;
  state = deepClone(SEED);
  initPositionsIfNeeded();
  autoOrganize(true);
  selectedNodeId=null;
  persist();
  renderAll();
  centerNow();
}

/* ==== Anim toggle ==== */
function toggleAnim(){
  animOn = !animOn;
  document.getElementById("btnAnim").textContent = "Animar: " + (animOn ? "ON" : "OFF");
}
</script>
</body>
</html>
