<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>IntegraProjetos — Integração de Projetos</title>
  <meta name="theme-color" content="#ffffff"/>

  <style>
    :root{
      --bg:#ffffff;
      --panel:#ffffffcc;
      --panel2:#ffffffee;
      --stroke:#e6e8ef;
      --stroke2:#cfd6e6;
      --txt:#101828;
      --muted:#667085;

      --shadow: 0 18px 40px rgba(16,24,40,.12);
      --shadow2: 0 10px 22px rgba(16,24,40,.10);
      --radius:18px;

      --purple:#7c3aed;
      --green:#10b981;
      --orange:#f59e0b;
      --blue:#2563eb;
      --pink:#ec4899;
      --red:#ef4444;

      --card:#f7f8fb;
      --card2:#ffffff;

      --btn:#ffffff;
      --btnStroke:#d0d5dd;

      /* layout dynamic */
      --topH: 78px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--txt);
      background:
        radial-gradient(1200px 700px at 10% 10%, rgba(124,58,237,.10), transparent 60%),
        radial-gradient(900px 600px at 90% 20%, rgba(16,185,129,.10), transparent 60%),
        radial-gradient(1000px 700px at 40% 90%, rgba(245,158,11,.08), transparent 60%),
        var(--bg);
      overflow:hidden;
    }

    .topbar{
      position:fixed;
      left:12px; right:12px; top:12px;
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; flex-wrap:wrap;
      padding:10px 12px;
      border:1px solid var(--stroke);
      background:var(--panel);
      backdrop-filter: blur(10px);
      border-radius:16px;
      box-shadow: var(--shadow);
      z-index:50;
    }
    .brand{ display:flex; gap:10px; align-items:center; min-width:280px; }
    .logo{
      width:38px; height:38px; border-radius:14px;
      background: linear-gradient(135deg, rgba(124,58,237,.95), rgba(16,185,129,.90));
      box-shadow: 0 10px 18px rgba(124,58,237,.22);
      border: 1px solid rgba(255,255,255,.45);
    }
    .brand h1{ margin:0; font-size:14px; font-weight:900; letter-spacing:.2px; }
    .brand p{ margin:2px 0 0; font-size:12px; color:var(--muted); }

    .actions{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }

    button{
      border:1px solid var(--btnStroke);
      background:var(--btn);
      color:var(--txt);
      border-radius:12px;
      padding:9px 10px;
      font-weight:850;
      font-size:12px;
      cursor:pointer;
      box-shadow: var(--shadow2);
      transition: transform .05s ease, box-shadow .15s ease;
      user-select:none;
      white-space:nowrap;
    }
    button:hover{ box-shadow: 0 14px 28px rgba(16,24,40,.12); }
    button:active{ transform: translateY(1px); }

    .primary{
      border-color: transparent;
      background: linear-gradient(135deg, rgba(124,58,237,.95), rgba(16,185,129,.88));
      color:white;
    }
    .warn{
      border-color: rgba(245,158,11,.35);
      background: rgba(245,158,11,.10);
    }
    .danger{
      border-color: rgba(239,68,68,.35);
      background: rgba(239,68,68,.10);
    }

    .status{
      display:inline-flex; align-items:center; gap:8px;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: var(--panel2);
      color:var(--muted);
      font-size:12px;
      box-shadow: var(--shadow2);
    }
    .dot{ width:10px; height:10px; border-radius:999px; background:var(--green); border:1px solid rgba(16,24,40,.08); }

    /* slider */
    .sliderWrap{
      display:flex; align-items:center; gap:8px;
      padding:7px 10px;
      border-radius:12px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.92);
      box-shadow: var(--shadow2);
    }
    .sliderWrap label{ font-size:12px; color:var(--muted); font-weight:800; }
    input[type="range"]{ width:120px; }

    /* Layout main — TOP is dynamic */
    #stage{
      position:fixed;
      left:12px; bottom:12px;
      top: calc(var(--topH) + 12px);
      right: 430px;
      border:1px solid var(--stroke);
      border-radius:18px;
      background: linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.72));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    #svg{ width:100%; height:100%; display:block; }

    aside{
      position:fixed;
      right:12px; bottom:12px;
      top: calc(var(--topH) + 12px);
      width:410px;
      border:1px solid var(--stroke);
      border-radius:18px;
      background: var(--panel2);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      z-index:40;
    }

    aside header{
      padding:12px;
      border-bottom:1px solid var(--stroke);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      background: rgba(255,255,255,.92);
    }
    aside header h2{ margin:0; font-size:13px; font-weight:950; }
    aside header .sub{ margin-top:2px; font-size:12px; color:var(--muted); line-height:1.25; }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      border:1px solid var(--stroke);
      background: #fff;
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
      box-shadow: var(--shadow2);
    }

    .toolbar{
      padding:10px 12px;
      border-bottom:1px solid var(--stroke);
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      background: rgba(255,255,255,.92);
    }

    .content{
      padding:12px;
      overflow:auto;
      flex:1;
      background: rgba(255,255,255,.72);
    }

    .card{
      background: var(--card2);
      border:1px solid var(--stroke);
      border-radius:16px;
      padding:12px;
      box-shadow: var(--shadow2);
    }
    .card .meta{ color:var(--muted); font-size:12px; }
    .card b{ font-size:13px; }

    .list{ display:grid; gap:10px; }
    .rowbtns{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }

    input[type="text"], textarea, select{
      width:100%;
      border-radius:12px;
      border:1px solid var(--stroke2);
      background:#fff;
      padding:10px 10px;
      font-size:13px;
      outline:none;
    }
    textarea{ min-height:76px; resize:vertical; }
    .sep{ height:1px; background:var(--stroke); margin:10px 0; }

    .legend{
      position:absolute;
      left:12px; bottom:12px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      z-index:10;
      pointer-events:none;
    }
    .tag{
      display:inline-flex; align-items:center; gap:8px;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.9);
      color:var(--muted);
      font-size:12px;
      box-shadow: var(--shadow2);
    }
    .tag .dot{ border:none; }

    /* Modal */
    .modal{
      position:fixed; inset:0;
      background: rgba(16,24,40,.35);
      display:none;
      place-items:center;
      padding:12px;
      z-index:200;
    }
    .modal[open]{ display:grid; }
    .box{
      width:min(900px, calc(100vw - 24px));
      max-height: min(90vh, 920px);
      overflow:auto;
      border-radius:18px;
      border:1px solid var(--stroke);
      background:#fff;
      box-shadow: var(--shadow);
      padding:12px;
    }
    .box header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:8px 8px 10px;
      border-bottom:1px solid var(--stroke);
    }
    .box header h3{ margin:0; font-size:14px; font-weight:950; }
    .box .body{ padding:10px 8px 8px; }

    /* Responsive */
    @media (max-width: 980px){
      #stage{ right:12px; bottom:52vh; }
      aside{ left:12px; right:12px; width:auto; top:auto; height:50vh; }
      .sliderWrap{ width:100%; justify-content:space-between; }
      input[type="range"]{ width:160px; }
    }
  </style>
</head>

<body>
  <div class="topbar" id="topbar">
    <div class="brand">
      <div class="logo"></div>
      <div>
        <h1>IntegraProjetos — Rede visual de integração</h1>
        <p>Arraste bolinhas • clique para ver/editar • crie ligações (origem → destino) com motivo, perguntas e resultados</p>
      </div>
    </div>

    <div class="actions">
      <button class="primary" id="btnAdd">+ Adicionar pessoa</button>
      <button id="btnAddLink">+ Criar ligação</button>
      <button id="btnAuto">Auto-organizar</button>
      <button id="btnGroup">Organizar por grupos</button>
      <button id="btnFit">Ver todos (Fit)</button>
      <button id="btnAnim">Animar: ON</button>

      <div class="sliderWrap" title="Ajuste ideal pra quando você tiver 52 pessoas">
        <label for="nodeSize">Tamanho</label>
        <input id="nodeSize" type="range" min="12" max="30" step="1"/>
        <span class="pill" id="nodeSizeLabel">22</span>
      </div>

      <button id="btnExportPNG">Baixar PNG</button>
      <button id="btnExportSVG">Baixar SVG</button>
      <button id="btnExport">Baixar JSON</button>
      <button class="warn" id="btnImport">Importar JSON</button>

      <span class="status" title="Se ficar vermelho, o navegador bloqueou o armazenamento. Use Baixar/Importar JSON.">
        <span class="dot" id="saveDot"></span>
        <span id="saveText">Salvo ✓</span>
      </span>

      <button class="danger" id="btnResetClean">Reset limpo</button>
      <button class="danger" id="btnResetSeed">Reset modelo</button>
    </div>
  </div>

  <div id="stage">
    <svg id="svg"></svg>

    <div class="legend" aria-hidden="true">
      <span class="tag"><span class="dot" style="background:var(--purple)"></span>Dados/integração</span>
      <span class="tag"><span class="dot" style="background:var(--green)"></span>Produto/jogo</span>
      <span class="tag"><span class="dot" style="background:var(--orange)"></span>Extensão/visibilidade</span>
      <span class="tag"><span class="dot" style="background:var(--blue)"></span>Análise científica</span>
      <span class="tag"><span class="dot" style="background:var(--red)"></span>Campo/coleta</span>
    </div>
  </div>

  <aside>
    <header>
      <div>
        <h2 id="sideTitle">Pessoas</h2>
        <div class="sub" id="sideSub">Use “Ver todos (Fit)” se sumir. Clique numa bolinha para abrir detalhes.</div>
      </div>
      <span class="pill" id="countPill">0 pessoas</span>
    </header>

    <div class="toolbar">
      <input type="text" id="search" placeholder="Buscar pessoa..." />
      <button id="btnShowList">Lista</button>
      <button id="btnShowDetails" disabled>Detalhes</button>
    </div>

    <div class="content" id="sideContent"></div>
  </aside>

  <!-- Modal Pessoa -->
  <div class="modal" id="modalPerson">
    <div class="box">
      <header>
        <h3 id="personTitle">Adicionar pessoa</h3>
        <div style="display:flex; gap:8px; flex-wrap:wrap">
          <button id="closePerson">Fechar</button>
          <button class="primary" id="savePerson">Salvar</button>
        </div>
      </header>
      <div class="body">
        <div style="display:grid; gap:10px">
          <div style="display:flex; gap:10px; flex-wrap:wrap">
            <div style="flex:1; min-width:240px">
              <div class="meta">Nome</div>
              <input type="text" id="p_name" placeholder="Ex.: Letícia Zen"/>
            </div>
            <div style="width:180px; min-width:180px">
              <div class="meta">Nível</div>
              <select id="p_level">
                <option>Graduação</option>
                <option>Mestrado</option>
                <option>Doutorado</option>
                <option>Pós-doutorado</option>
                <option>Professor</option>
                <option>Colaborador</option>
              </select>
            </div>
          </div>

          <div style="display:flex; gap:10px; flex-wrap:wrap">
            <div style="flex:1; min-width:240px">
              <div class="meta">Área</div>
              <input type="text" id="p_area" placeholder="Ex.: Clima & Saúde"/>
            </div>
            <div style="width:220px; min-width:220px">
              <div class="meta">Cor da bolinha</div>
              <select id="p_color">
                <option value="var(--blue)">Azul</option>
                <option value="var(--purple)">Roxo</option>
                <option value="var(--green)">Verde</option>
                <option value="var(--orange)">Laranja</option>
                <option value="var(--pink)">Rosa</option>
                <option value="var(--red)">Vermelho</option>
              </select>
            </div>
          </div>

          <div>
            <div class="meta">Grupo (opcional — ex.: “Carbono”, “Clima & Saúde”, “Extensão”)</div>
            <input type="text" id="p_group" placeholder="Se preencher, o botão ‘Organizar por grupos’ cria círculos por grupo."/>
          </div>

          <div>
            <div class="meta">Título do trabalho</div>
            <input type="text" id="p_title"/>
          </div>
          <div>
            <div class="meta">Objetivos</div>
            <textarea id="p_obj"></textarea>
          </div>
          <div>
            <div class="meta">Resultados esperados</div>
            <textarea id="p_exp"></textarea>
          </div>
          <div>
            <div class="meta">Tags (separadas por vírgula)</div>
            <input type="text" id="p_tags" placeholder="planilhas, gráficos, carbono..."/>
          </div>
          <div class="meta">
            Dica: se “Salvo ✓” ficar vermelho, use Baixar/Importar JSON.
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Ligação -->
  <div class="modal" id="modalLink">
    <div class="box">
      <header>
        <h3 id="linkTitle">Criar ligação</h3>
        <div style="display:flex; gap:8px; flex-wrap:wrap">
          <button id="closeLink">Fechar</button>
          <button class="primary" id="saveLink">Salvar ligação</button>
        </div>
      </header>
      <div class="body">
        <div style="display:grid; gap:10px">
          <div style="display:flex; gap:10px; flex-wrap:wrap">
            <div style="flex:1; min-width:240px">
              <div class="meta">Origem</div>
              <select id="l_from"></select>
            </div>
            <div style="flex:1; min-width:240px">
              <div class="meta">Destino</div>
              <select id="l_to"></select>
            </div>
          </div>

          <div style="display:flex; gap:10px; flex-wrap:wrap">
            <div style="flex:1; min-width:240px">
              <div class="meta">Tipo</div>
              <select id="l_type">
                <option value="dados">Dados/integração</option>
                <option value="analise">Análise científica</option>
                <option value="extensao">Extensão/visibilidade</option>
                <option value="produto">Produto/jogo</option>
                <option value="campo">Campo/coleta</option>
                <option value="outro">Outro</option>
              </select>
            </div>
            <div style="width:180px; min-width:180px">
              <div class="meta">Força</div>
              <select id="l_weight">
                <option>1</option><option>2</option><option selected>3</option><option>4</option><option>5</option>
              </select>
            </div>
          </div>

          <div>
            <div class="meta">Por que liga?</div>
            <textarea id="l_reason"></textarea>
          </div>
          <div>
            <div class="meta">Perguntas</div>
            <textarea id="l_questions"></textarea>
          </div>
          <div>
            <div class="meta">Resultados esperados da ligação</div>
            <textarea id="l_outputs"></textarea>
          </div>
        </div>
      </div>
    </div>
  </div>

  <input type="file" id="fileImport" accept="application/json" style="display:none"/>

<script>
/* ============================
   IntegraProjetos v5
   - Layout dinâmico (menu não cobre nada)
   - Slider de tamanho das bolinhas (ideal 52 pessoas)
   - Organizar por grupos (círculos por grupo + halos)
   - Exportar PNG e SVG
============================ */

const STORAGE_KEY = "integraprojetos_v5";

/* ---------- Utils ---------- */
const uid = ()=> "id_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
const clone = (o)=> JSON.parse(JSON.stringify(o));
const esc = (s)=> String(s ?? "")
  .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
  .replaceAll('"',"&quot;").replaceAll("'","&#039;");

function cssVar(v){
  const m = /^var\((--[a-z]+)\)$/i.exec(v || "");
  if(!m) return v;
  const computed = getComputedStyle(document.documentElement).getPropertyValue(m[1]).trim();
  return computed || v;
}

function linkColor(type){
  const root = getComputedStyle(document.documentElement);
  switch(type){
    case "dados": return root.getPropertyValue("--purple").trim();
    case "produto": return root.getPropertyValue("--green").trim();
    case "extensao": return root.getPropertyValue("--orange").trim();
    case "analise": return root.getPropertyValue("--blue").trim();
    case "campo": return root.getPropertyValue("--red").trim();
    default: return "rgba(16,24,40,.28)";
  }
}
function typeLabel(type){
  switch(type){
    case "dados": return "dados";
    case "produto": return "produto";
    case "extensao": return "extensão";
    case "analise": return "análise";
    case "campo": return "campo";
    default: return "outro";
  }
}
function download(text, filename, mime){
  const blob = new Blob([text], {type:mime});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href=url; a.download=filename;
  document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 800);
}

/* ---------- Seed (7 alunos) ---------- */
const SEED = {
  meta:{ app:"IntegraProjetos", version:5, updatedAt:new Date().toISOString(), nodeSize:22 },
  nodes:[
    { id: uid(), name:"Letícia Zen", level:"Graduação", area:"Clima & Saúde", group:"Clima & Saúde",
      title:"Impacto do calor na mortalidade em MT (dados secundários)",
      objectives:"Análise de dados secundários sobre o impacto do calor na mortalidade em MT.",
      expected:"Organização de planilhas e produção de gráficos comparativos e analíticos.",
      tags:["mortalidade","calor","planilhas","gráficos","MT"], color:"var(--blue)"
    },
    { id: uid(), name:"Cintya", level:"Graduação", area:"Extensão & Visibilidade", group:"Extensão",
      title:"Extensão na pós: visibilidade e identificação de projetos",
      objectives:"Produção de dados sobre a extensão na pós-graduação, com análise e identificação de projetos para dar visibilidade.",
      expected:"Identificação de projetos para a visibilidade da pós da UNEMAT.",
      tags:["extensão","pós","visibilidade","mapeamento"], color:"var(--orange)"
    },
    { id: uid(), name:"Antônio", level:"Graduação", area:"Atividade Física & Ambiente", group:"Campo/Temperatura",
      title:"Efeito da temperatura em atividade física (aberto/fechado/escolas)",
      objectives:"Avalia o efeito da temperatura em atividades físicas de áreas abertas, fechadas e em escolas.",
      expected:"Coleta em ambientes em Cáceres; organização de planilhas; análises e comparações térmicas.",
      tags:["temperatura","atividade física","Cáceres","campo"], color:"var(--green)"
    },
    { id: uid(), name:"Luan", level:"Graduação", area:"Jogos & Educação", group:"Jogos",
      title:"Jogo interativo sobre carbono (rumo ao 3D)",
      objectives:"Produção de jogos interativos sobre carbono; análise de itens necessários para produção.",
      expected:"Produzir um jogo 3D sobre carbono.",
      tags:["jogos","carbono","3D","educação"], color:"var(--purple)"
    },
    { id: uid(), name:"Matheus", level:"Graduação", area:"Carbono (dados)", group:"Carbono",
      title:"Inspetor/organizador de planilhas do laboratório (carbono)",
      objectives:"Organiza dados de carbono e atua como inspetor de qualidade e integração de planilhas.",
      expected:"Revisar planilhas para integração de dados do laboratório.",
      tags:["planilhas","carbono","integração","qualidade"], color:"var(--green)"
    },
    { id: uid(), name:"Leandro", level:"Graduação", area:"Carbono (processos)", group:"Carbono",
      title:"ATTZ e dinâmica do carbono na praia de Cáceres",
      objectives:"Analisa a influência da ATTZ na dinâmica do carbono em praia de Cáceres.",
      expected:"Identificar dinâmica das águas e influência no fluxo de CO₂ de áreas alagáveis até secas.",
      tags:["ATTZ","CO2","hidrodinâmica","alagável"], color:"var(--blue)"
    },
    { id: uid(), name:"Vanessa", level:"Graduação", area:"Jogos & Educação", group:"Jogos",
      title:"Jogos físicos + Guardiões do Clima (ensino médio)",
      objectives:"Produção de jogos físicos para integração com estudantes; monitora dos Guardiões do Clima.",
      expected:"Produzir jogos sobre carbono e mudanças climáticas para crianças e adolescentes.",
      tags:["jogos físicos","ensino médio","clima","carbono"], color:"var(--pink)"
    }
  ],
  links:[]
};

/* ---------- DOM ---------- */
const topbar = document.getElementById("topbar");
const stage = document.getElementById("stage");
const svg = document.getElementById("svg");
const sideContent = document.getElementById("sideContent");
const countPill = document.getElementById("countPill");
const sideTitle = document.getElementById("sideTitle");
const sideSub = document.getElementById("sideSub");

const saveDot = document.getElementById("saveDot");
const saveText = document.getElementById("saveText");

const search = document.getElementById("search");
const btnShowList = document.getElementById("btnShowList");
const btnShowDetails = document.getElementById("btnShowDetails");

const nodeSizeRange = document.getElementById("nodeSize");
const nodeSizeLabel = document.getElementById("nodeSizeLabel");

/* modals */
const modalPerson = document.getElementById("modalPerson");
const modalLink = document.getElementById("modalLink");

const p_name = document.getElementById("p_name");
const p_level = document.getElementById("p_level");
const p_area = document.getElementById("p_area");
const p_color = document.getElementById("p_color");
const p_group = document.getElementById("p_group");
const p_title = document.getElementById("p_title");
const p_obj = document.getElementById("p_obj");
const p_exp = document.getElementById("p_exp");
const p_tags = document.getElementById("p_tags");

const l_from = document.getElementById("l_from");
const l_to = document.getElementById("l_to");
const l_type = document.getElementById("l_type");
const l_weight = document.getElementById("l_weight");
const l_reason = document.getElementById("l_reason");
const l_questions = document.getElementById("l_questions");
const l_outputs = document.getElementById("l_outputs");

const fileImport = document.getElementById("fileImport");

/* buttons */
document.getElementById("btnAdd").addEventListener("click", ()=> openPerson(null));
document.getElementById("btnAddLink").addEventListener("click", ()=> openLink(null));
document.getElementById("btnAuto").addEventListener("click", ()=> { autoOrganize(); });
document.getElementById("btnGroup").addEventListener("click", ()=> { organizeByGroups(); });
document.getElementById("btnFit").addEventListener("click", ()=> fitToAll(true));
document.getElementById("btnAnim").addEventListener("click", ()=> toggleAnim());
document.getElementById("btnExport").addEventListener("click", exportJSON);
document.getElementById("btnExportSVG").addEventListener("click", exportSVG);
document.getElementById("btnExportPNG").addEventListener("click", exportPNG);
document.getElementById("btnImport").addEventListener("click", ()=> fileImport.click());
document.getElementById("btnResetClean").addEventListener("click", resetClean);
document.getElementById("btnResetSeed").addEventListener("click", resetSeed);

document.getElementById("closePerson").addEventListener("click", ()=> closeModal(modalPerson));
document.getElementById("savePerson").addEventListener("click", savePerson);
document.getElementById("closeLink").addEventListener("click", ()=> closeModal(modalLink));
document.getElementById("saveLink").addEventListener("click", saveLink);

fileImport.addEventListener("change", importJSONFile);

btnShowList.addEventListener("click", ()=> { viewMode="list"; renderSide(); });
btnShowDetails.addEventListener("click", ()=> { if(selectedId) { viewMode="details"; renderSide(); } });

search.addEventListener("input", ()=> renderSide());
nodeSizeRange.addEventListener("input", ()=>{
  const v = Number(nodeSizeRange.value);
  nodeSizeLabel.textContent = String(v);
  state.meta.nodeSize = v;
  persist();
});

modalPerson.addEventListener("click", (e)=> { if(e.target===modalPerson) closeModal(modalPerson); });
modalLink.addEventListener("click", (e)=> { if(e.target===modalLink) closeModal(modalLink); });

/* ---------- SVG setup ---------- */
function makeSvg(tag, attrs={}){
  const el = document.createElementNS("http://www.w3.org/2000/svg", tag);
  for(const [k,v] of Object.entries(attrs)) el.setAttribute(k, v);
  return el;
}
svg.innerHTML = "";
const gRoot = makeSvg("g", {id:"root"});
const gGroup = makeSvg("g", {id:"groups"});
const gLinks = makeSvg("g", {id:"links"});
const gNodes = makeSvg("g", {id:"nodes"});
gRoot.appendChild(gGroup);
gRoot.appendChild(gLinks);
gRoot.appendChild(gNodes);
svg.appendChild(gRoot);

/* ---------- State ---------- */
let state = loadState();
state = normalize(state);

let selectedId = null;
let editPersonId = null;
let editLinkId = null;

let viewMode = "list"; // list | details

let W=1200, H=800;
let pan = {x:0, y:0};
let zoom = 1.0;

let anim = true;
let raf = null;
let lastT = performance.now();

let dragging = null;

/* ---------- Dynamic topbar height -> CSS var --topH ---------- */
function updateTopH(){
  const h = topbar.getBoundingClientRect().height;
  document.documentElement.style.setProperty("--topH", Math.ceil(h) + "px");
}
const ro = new ResizeObserver(updateTopH);
ro.observe(topbar);
updateTopH();

/* ---------- Resize ---------- */
function resize(){
  const r = stage.getBoundingClientRect();
  W = Math.max(700, Math.floor(r.width));
  H = Math.max(520, Math.floor(r.height));
  svg.setAttribute("viewBox", `0 0 ${W} ${H}`);
}
window.addEventListener("resize", ()=> { resize(); fitToAll(false); renderGraph(); });
resize();

/* ---------- Storage ---------- */
let saveTimer = null;
function setSaved(ok, msg){
  if(saveTimer) clearTimeout(saveTimer);
  saveDot.style.background = ok ? "var(--green)" : "var(--red)";
  saveText.textContent = msg || (ok ? "Salvo ✓" : "Não salvou");
  saveTimer = setTimeout(()=> {
    if(ok){ saveDot.style.background="var(--green)"; saveText.textContent="Salvo ✓"; }
  }, 2500);
}
function persist(){
  try{
    state.meta.updatedAt = new Date().toISOString();
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    setSaved(true);
  }catch(e){
    setSaved(false, "Storage bloqueado — use JSON");
  }
}
function loadState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return clone(SEED);
    return JSON.parse(raw);
  }catch{
    return clone(SEED);
  }
}
function normalize(obj){
  const meta = obj.meta || {app:"IntegraProjetos", version:5, updatedAt:new Date().toISOString(), nodeSize:22};
  return {
    meta: { ...meta, nodeSize: Number(meta.nodeSize||22) },
    nodes: (obj.nodes||[]).map(n=>({
      id: n.id || uid(),
      name: n.name || "Sem nome",
      level: n.level || "Graduação",
      area: n.area || "",
      group: n.group || "",
      title: n.title || "",
      objectives: n.objectives || "",
      expected: n.expected || "",
      tags: Array.isArray(n.tags) ? n.tags : [],
      color: n.color || "var(--blue)",
      x: Number.isFinite(n.x) ? n.x : 0,
      y: Number.isFinite(n.y) ? n.y : 0,
      vx: Number.isFinite(n.vx) ? n.vx : 0,
      vy: Number.isFinite(n.vy) ? n.vy : 0,
      fx: null,
      fy: null
    })),
    links: (obj.links||[]).map(l=>({
      id: l.id || uid(),
      from: l.from, to: l.to,
      type: l.type || "dados",
      weight: Number(l.weight||3),
      reason: l.reason || "",
      questions: l.questions || "",
      outputs: l.outputs || ""
    }))
  };
}
function getNode(id){ return state.nodes.find(n=>n.id===id); }

/* ---------- Init positions ---------- */
function initPositions(){
  const cx=W/2, cy=H/2;
  const R = Math.min(W,H)*0.28;
  state.nodes.forEach((n,i)=>{
    if(!Number.isFinite(n.x) || !Number.isFinite(n.y) || (n.x===0 && n.y===0)){
      const a = (i/Math.max(1,state.nodes.length))*Math.PI*2;
      n.x = cx + Math.cos(a)*R + (Math.random()-.5)*40;
      n.y = cy + Math.sin(a)*R + (Math.random()-.5)*40;
    }
  });
}
initPositions();

/* slider init */
nodeSizeRange.value = String(state.meta.nodeSize || 22);
nodeSizeLabel.textContent = String(state.meta.nodeSize || 22);

fitToAll(false);
renderAll();
start();

/* ---------- Graph rendering ---------- */
function renderAll(){
  countPill.textContent = `${state.nodes.length} pessoas`;
  renderSide();
  renderGraph();
}

function getBaseRadius(){
  // usuário controla via slider; também compacta automaticamente se tiver muita gente
  const manual = Number(state.meta.nodeSize || 22);
  const n = state.nodes.length;
  const auto = (n > 30) ? Math.max(12, manual - Math.floor((n-30)*0.15)) : manual;
  return Math.max(12, Math.min(30, auto));
}

function renderGraph(){
  gRoot.setAttribute("transform", `translate(${pan.x} ${pan.y}) scale(${zoom})`);

  // group halos
  gGroup.innerHTML = "";
  const groups = groupMap();
  if(groups.size > 0){
    for(const [gname, ids] of groups.entries()){
      if(!gname.trim()) continue;
      const pts = ids.map(id=>getNode(id)).filter(Boolean);
      if(pts.length < 2) continue;

      // compute centroid + radius
      const cx = pts.reduce((a,n)=>a+n.x,0)/pts.length;
      const cy = pts.reduce((a,n)=>a+n.y,0)/pts.length;
      let maxD = 0;
      for(const n of pts){
        const dx=n.x-cx, dy=n.y-cy;
        maxD = Math.max(maxD, Math.sqrt(dx*dx+dy*dy));
      }
      const ringR = maxD + 90;

      const ring = makeSvg("circle",{
        cx, cy, r: ringR,
        fill:"rgba(124,58,237,.04)",
        stroke:"rgba(16,24,40,.10)",
        "stroke-width":"2"
      });
      gGroup.appendChild(ring);

      const label = makeSvg("text",{
        x: cx, y: cy - ringR - 12,
        fill:"rgba(16,24,40,.72)",
        "font-size":"13",
        "font-weight":"900",
        "text-anchor":"middle"
      });
      label.textContent = gname;
      gGroup.appendChild(label);
    }
  }

  // links
  gLinks.innerHTML = "";
  state.links.forEach(l=>{
    const a = getNode(l.from), b = getNode(l.to);
    if(!a||!b) return;

    const line = makeSvg("line",{
      x1:a.x, y1:a.y, x2:b.x, y2:b.y,
      stroke: linkColor(l.type),
      "stroke-width": 2 + (l.weight||3)*1.4,
      "stroke-linecap":"round",
      "stroke-opacity": selectedId ? ((l.from===selectedId||l.to===selectedId)? .9 : .22) : .62
    });
    line.style.cursor="pointer";
    line.addEventListener("click",(e)=>{ e.stopPropagation(); openLink(l.id); });
    gLinks.appendChild(line);

    const mx=(a.x+b.x)/2, my=(a.y+b.y)/2;
    const label = makeSvg("text",{
      x:mx, y:my-8,
      fill:"rgba(16,24,40,.62)",
      "font-size":"12",
      "text-anchor":"middle",
      "font-weight":"800"
    });
    label.textContent = typeLabel(l.type);
    label.style.pointerEvents="none";
    gLinks.appendChild(label);
  });

  // nodes
  gNodes.innerHTML = "";
  const baseR = getBaseRadius();

  state.nodes.forEach(n=>{
    const isSel = n.id===selectedId;

    // tags affect slightly, but not huge
    const tagsBoost = Math.min(6, (n.tags||[]).length);
    const r = baseR + Math.floor(tagsBoost*0.6);

    const group = makeSvg("g", {"data-id":n.id});
    group.style.cursor="grab";

    const glow = makeSvg("circle",{
      cx:n.x, cy:n.y, r:r+16,
      fill:"rgba(124,58,237,.06)",
      stroke: isSel ? "rgba(16,185,129,.60)" : "rgba(16,24,40,.10)",
      "stroke-width": isSel ? 2.6 : 1.2
    });
    gNodes.appendChild(glow);

    const c = makeSvg("circle",{
      cx:n.x, cy:n.y, r:r,
      fill: cssVar(n.color),
      stroke:"rgba(255,255,255,.90)",
      "stroke-width": 2
    });
    c.style.filter = "drop-shadow(0 10px 16px rgba(16,24,40,.14))";
    group.appendChild(c);

    const name = makeSvg("text",{
      x:n.x, y:n.y + r + 18,
      fill:"rgba(16,24,40,.86)",
      "font-size": (state.nodes.length>40 ? "12" : "13"),
      "font-weight":"900",
      "text-anchor":"middle"
    });
    name.textContent = n.name;
    group.appendChild(name);

    const area = makeSvg("text",{
      x:n.x, y:n.y + r + 34,
      fill:"rgba(102,112,133,.92)",
      "font-size":"11",
      "font-weight":"700",
      "text-anchor":"middle"
    });
    area.textContent = n.area;
    group.appendChild(area);

    group.addEventListener("mousedown",(e)=> startDrag(e,n.id));
    group.addEventListener("touchstart",(e)=> startDrag(e,n.id), {passive:false});
    group.addEventListener("click",(e)=>{
      e.stopPropagation();
      selectedId = n.id;
      viewMode="details";
      btnShowDetails.disabled = false;
      renderSide();
      renderGraph();
    });

    gNodes.appendChild(group);
  });

  svg.onclick = ()=>{
    selectedId=null;
    viewMode="list";
    btnShowDetails.disabled = true;
    renderAll();
  };
}

/* ---------- Side panel ---------- */
function renderSide(){
  if(viewMode==="details" && selectedId && getNode(selectedId)){
    const n = getNode(selectedId);
    sideTitle.textContent = n.name;
    sideSub.textContent = `${n.level} • ${n.area}${n.group? " • Grupo: "+n.group:""}`;

    const rel = state.links.filter(l=>l.from===n.id || l.to===n.id);

    sideContent.innerHTML = `
      <div class="card">
        <b>${esc(n.title || "Sem título")}</b>
        <div class="meta" style="margin-top:6px">${esc(n.level)} • ${esc(n.area)}${n.group? " • "+esc(n.group):""}</div>
        <div class="sep"></div>

        <div class="meta">Objetivos</div>
        <div style="white-space:pre-wrap; margin-top:6px">${esc(n.objectives||"")}</div>

        <div class="sep"></div>

        <div class="meta">Resultados esperados</div>
        <div style="white-space:pre-wrap; margin-top:6px">${esc(n.expected||"")}</div>

        <div class="sep"></div>

        <div class="meta">Tags</div>
        <div style="margin-top:8px; display:flex; gap:6px; flex-wrap:wrap">
          ${(n.tags||[]).map(t=>`<span class="pill">${esc(t)}</span>`).join("") || `<span class="meta">Sem tags.</span>`}
        </div>

        <div class="rowbtns" style="margin-top:12px">
          <button id="d_focus">Focar</button>
          <button id="d_edit">Editar</button>
          <button class="danger" id="d_del">Excluir</button>
          <button id="d_link">Criar ligação</button>
        </div>
      </div>

      <div style="height:10px"></div>

      <div class="card">
        <b>Ligações (${rel.length})</b>
        <div class="meta" style="margin-top:4px">Clique para editar ou excluir a ligação.</div>
        <div class="sep"></div>
        <div class="list" id="relList"></div>
      </div>
    `;

    document.getElementById("d_focus").onclick = ()=> focusNode(n.id, true);
    document.getElementById("d_edit").onclick = ()=> openPerson(n.id);
    document.getElementById("d_del").onclick = ()=> deletePerson(n.id);
    document.getElementById("d_link").onclick = ()=> openLink(null, n.id);

    const relList = document.getElementById("relList");
    rel.forEach(l=>{
      const otherId = (l.from===n.id)? l.to : l.from;
      const other = getNode(otherId);
      const div = document.createElement("div");
      div.className="card";
      div.innerHTML = `
        <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:10px">
          <div>
            <b>${esc(other? other.name : "—")}</b>
            <div class="meta">${esc(typeLabel(l.type))} • força ${esc(String(l.weight||3))}</div>
          </div>
          <span class="pill" style="border-color:${linkColor(l.type)}; color:#475467">${esc(typeLabel(l.type))}</span>
        </div>
        <div class="meta" style="margin-top:10px">Por quê</div>
        <div style="white-space:pre-wrap; margin-top:4px">${esc(l.reason||"")}</div>
        <div class="rowbtns">
          <button class="warn" data-edit="1">Editar ligação</button>
          <button class="danger" data-del="1">Excluir ligação</button>
        </div>
      `;
      div.querySelector('[data-edit="1"]').onclick = ()=> openLink(l.id);
      div.querySelector('[data-del="1"]').onclick = ()=> deleteLink(l.id);
      relList.appendChild(div);
    });

    return;
  }

  sideTitle.textContent = "Pessoas";
  sideSub.textContent = "Buscar, abrir, editar, excluir. Use “Ver todos (Fit)” para recuperar a rede.";
  const q = (search.value||"").trim().toLowerCase();

  const nodes = [...state.nodes]
    .filter(n=>{
      if(!q) return true;
      return (n.name||"").toLowerCase().includes(q) ||
             (n.area||"").toLowerCase().includes(q) ||
             (n.group||"").toLowerCase().includes(q) ||
             (n.title||"").toLowerCase().includes(q);
    })
    .sort((a,b)=> (a.name||"").localeCompare((b.name||""), "pt-BR"));

  sideContent.innerHTML = `
    <div class="card">
      <b>Atalhos rápidos</b>
      <div class="meta" style="margin-top:6px">Se sumiu, clique: <b>Ver todos (Fit)</b>.</div>
      <div class="rowbtns">
        <button id="quick_fit">Ver todos (Fit)</button>
        <button id="quick_auto">Auto-organizar</button>
        <button id="quick_group">Organizar por grupos</button>
        <button id="quick_anim">${anim ? "Animar: ON" : "Animar: OFF"}</button>
      </div>
    </div>
    <div style="height:10px"></div>
    <div class="list" id="peopleList"></div>
  `;

  document.getElementById("quick_fit").onclick = ()=> fitToAll(true);
  document.getElementById("quick_auto").onclick = ()=> autoOrganize();
  document.getElementById("quick_group").onclick = ()=> organizeByGroups();
  document.getElementById("quick_anim").onclick = ()=> toggleAnim(true);

  const list = document.getElementById("peopleList");
  nodes.forEach(n=>{
    const div = document.createElement("div");
    div.className="card";
    div.innerHTML = `
      <b>${esc(n.name)}</b>
      <div class="meta" style="margin-top:4px">${esc(n.level)} • ${esc(n.area)}${n.group? " • "+esc(n.group):""}</div>
      <div class="meta" style="margin-top:6px">${esc(n.title||"")}</div>
      <div class="rowbtns">
        <button data-open="1">Abrir</button>
        <button data-focus="1">Focar</button>
        <button data-edit="1">Editar</button>
        <button class="danger" data-del="1">Excluir</button>
      </div>
    `;
    div.querySelector('[data-open="1"]').onclick = ()=>{
      selectedId = n.id;
      viewMode="details";
      btnShowDetails.disabled = false;
      renderAll();
      focusNode(n.id, true);
    };
    div.querySelector('[data-focus="1"]').onclick = ()=> focusNode(n.id, true);
    div.querySelector('[data-edit="1"]').onclick = ()=> openPerson(n.id);
    div.querySelector('[data-del="1"]').onclick = ()=> deletePerson(n.id);
    list.appendChild(div);
  });

  btnShowDetails.disabled = !(selectedId && getNode(selectedId));
}

/* ---------- Modal helpers ---------- */
function openModal(m){ m.setAttribute("open",""); }
function closeModal(m){ m.removeAttribute("open"); }

/* ---------- Pessoa CRUD ---------- */
function openPerson(id){
  editPersonId = id;
  if(id){
    const n = getNode(id);
    document.getElementById("personTitle").textContent = "Editar pessoa";
    p_name.value = n.name||"";
    p_level.value = n.level||"Graduação";
    p_area.value = n.area||"";
    p_color.value = n.color || "var(--blue)";
    p_group.value = n.group || "";
    p_title.value = n.title||"";
    p_obj.value = n.objectives||"";
    p_exp.value = n.expected||"";
    p_tags.value = (n.tags||[]).join(", ");
  }else{
    document.getElementById("personTitle").textContent = "Adicionar pessoa";
    p_name.value="";
    p_level.value="Graduação";
    p_area.value="";
    p_color.value="var(--blue)";
    p_group.value="";
    p_title.value="";
    p_obj.value="";
    p_exp.value="";
    p_tags.value="";
  }
  openModal(modalPerson);
}
function savePerson(){
  const name = p_name.value.trim();
  if(!name){ alert("Informe o nome."); return; }

  const node = {
    id: editPersonId || uid(),
    name,
    level: p_level.value,
    area: p_area.value.trim(),
    group: p_group.value.trim(),
    title: p_title.value.trim(),
    objectives: p_obj.value.trim(),
    expected: p_exp.value.trim(),
    tags: p_tags.value.split(",").map(s=>s.trim()).filter(Boolean),
    color: p_color.value
  };

  if(editPersonId){
    const idx = state.nodes.findIndex(n=>n.id===editPersonId);
    if(idx>=0){
      const old = state.nodes[idx];
      state.nodes[idx] = {...old, ...node};
    }
  }else{
    node.x = (W/2) + (Math.random()-.5)*120;
    node.y = (H/2) + (Math.random()-.5)*90;
    node.vx = (Math.random()-.5)*2.2;
    node.vy = (Math.random()-.5)*2.2;
    node.fx = null; node.fy = null;
    state.nodes.push(node);
  }

  persist();
  closeModal(modalPerson);

  selectedId = node.id;
  viewMode="details";
  btnShowDetails.disabled = false;
  renderAll();
  focusNode(node.id, true);
}
function deletePerson(id){
  const n = getNode(id);
  if(!n) return;
  if(!confirm(`Excluir "${n.name}"? Isso apaga também as ligações.`)) return;
  state.nodes = state.nodes.filter(x=>x.id!==id);
  state.links = state.links.filter(l=>l.from!==id && l.to!==id);
  if(selectedId===id) selectedId=null;
  persist();
  viewMode="list";
  btnShowDetails.disabled = true;
  renderAll();
  fitToAll(true);
}

/* ---------- Link CRUD ---------- */
function openLink(linkId, defaultFrom){
  editLinkId = linkId;

  const sorted = [...state.nodes].sort((a,b)=>a.name.localeCompare(b.name,"pt-BR"));
  l_from.innerHTML = sorted.map(n=>`<option value="${n.id}">${esc(n.name)}</option>`).join("");
  l_to.innerHTML = sorted.map(n=>`<option value="${n.id}">${esc(n.name)}</option>`).join("");

  if(linkId){
    const l = state.links.find(x=>x.id===linkId);
    document.getElementById("linkTitle").textContent = "Editar ligação";
    l_from.value = l.from;
    l_to.value = l.to;
    l_type.value = l.type || "dados";
    l_weight.value = String(l.weight||3);
    l_reason.value = l.reason||"";
    l_questions.value = l.questions||"";
    l_outputs.value = l.outputs||"";
  }else{
    document.getElementById("linkTitle").textContent = "Criar ligação";
    const from = defaultFrom || selectedId || state.nodes[0]?.id;
    const to = state.nodes.find(n=>n.id!==from)?.id || from;
    l_from.value = from;
    l_to.value = to;
    l_type.value = "dados";
    l_weight.value = "3";
    l_reason.value = "";
    l_questions.value = "";
    l_outputs.value = "";
  }

  openModal(modalLink);
}
function saveLink(){
  const from = l_from.value;
  const to = l_to.value;
  if(!from || !to || from===to){ alert("Escolha origem e destino diferentes."); return; }

  const link = {
    id: editLinkId || uid(),
    from, to,
    type: l_type.value,
    weight: Number(l_weight.value||3),
    reason: l_reason.value.trim(),
    questions: l_questions.value.trim(),
    outputs: l_outputs.value.trim()
  };

  if(editLinkId){
    const idx = state.links.findIndex(x=>x.id===editLinkId);
    if(idx>=0) state.links[idx]=link;
  }else{
    state.links.push(link);
  }

  persist();
  closeModal(modalLink);
  renderAll();
}
function deleteLink(id){
  if(!confirm("Excluir esta ligação?")) return;
  state.links = state.links.filter(l=>l.id!==id);
  persist();
  renderAll();
}

/* ---------- JSON export/import ---------- */
function exportJSON(){
  const out = {
    meta:{ app:"IntegraProjetos", version:5, exportedAt:new Date().toISOString(), nodeSize: state.meta.nodeSize },
    nodes: state.nodes.map(n=>({
      ...n,
      x: Math.round(n.x), y: Math.round(n.y),
      vx: Math.round(n.vx*1000)/1000,
      vy: Math.round(n.vy*1000)/1000
    })),
    links: state.links
  };
  download(JSON.stringify(out,null,2), "integraprojetos.json", "application/json");
}
function importJSONFile(ev){
  const f = ev.target.files[0];
  if(!f) return;
  const reader = new FileReader();
  reader.onload = ()=>{
    try{
      const obj = JSON.parse(reader.result);
      state = normalize(obj);
      nodeSizeRange.value = String(state.meta.nodeSize || 22);
      nodeSizeLabel.textContent = String(state.meta.nodeSize || 22);
      initPositions();
      persist();
      selectedId=null;
      viewMode="list";
      btnShowDetails.disabled = true;
      renderAll();
      fitToAll(true);
    }catch(e){
      alert("Falha ao importar: " + e.message);
    }finally{
      ev.target.value="";
    }
  };
  reader.readAsText(f);
}

/* ---------- Export SVG/PNG ---------- */
function serializedSVG(){
  // Clone SVG and inject background + proper xmlns
  const s = svg.cloneNode(true);
  s.setAttribute("xmlns","http://www.w3.org/2000/svg");
  s.setAttribute("xmlns:xlink","http://www.w3.org/1999/xlink");
  // white background rect
  const bg = document.createElementNS("http://www.w3.org/2000/svg","rect");
  bg.setAttribute("x","0"); bg.setAttribute("y","0");
  bg.setAttribute("width", String(W));
  bg.setAttribute("height", String(H));
  bg.setAttribute("fill","#ffffff");
  s.insertBefore(bg, s.firstChild);

  // ensure viewBox is present
  s.setAttribute("viewBox", `0 0 ${W} ${H}`);
  return new XMLSerializer().serializeToString(s);
}
function exportSVG(){
  const xml = serializedSVG();
  download(xml, "integraprojetos.svg", "image/svg+xml");
}
function exportPNG(){
  const xml = serializedSVG();
  const blob = new Blob([xml], {type:"image/svg+xml;charset=utf-8"});
  const url = URL.createObjectURL(blob);

  const img = new Image();
  img.onload = ()=>{
    const canvas = document.createElement("canvas");
    canvas.width = W * 2; // 2x for sharpness
    canvas.height = H * 2;
    const ctx = canvas.getContext("2d");
    ctx.fillStyle = "#ffffff";
    ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.drawImage(img, 0,0, canvas.width, canvas.height);

    canvas.toBlob((b)=>{
      const u = URL.createObjectURL(b);
      const a = document.createElement("a");
      a.href = u;
      a.download = "integraprojetos.png";
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=>URL.revokeObjectURL(u), 800);
    }, "image/png");

    URL.revokeObjectURL(url);
  };
  img.onerror = ()=>{
    alert("Falha ao gerar PNG. Tente Baixar SVG.");
    URL.revokeObjectURL(url);
  };
  img.src = url;
}

/* ---------- Reset ---------- */
function resetClean(){
  if(!confirm("Reset limpo: apagar TODAS as pessoas e ligações?")) return;
  state = normalize({ meta:{app:"IntegraProjetos", version:5, nodeSize: state.meta.nodeSize||22}, nodes:[], links:[] });
  try{ localStorage.removeItem(STORAGE_KEY); }catch{}
  persist();
  selectedId=null;
  viewMode="list";
  btnShowDetails.disabled = true;
  renderAll();
}
function resetSeed(){
  if(!confirm("Reset modelo: voltar para os 7 alunos iniciais?")) return;
  const seed = clone(SEED);
  seed.meta.nodeSize = state.meta.nodeSize || 22;
  state = normalize(seed);
  try{ localStorage.removeItem(STORAGE_KEY); }catch{}
  initPositions();
  persist();
  selectedId=null;
  viewMode="list";
  btnShowDetails.disabled = true;
  renderAll();
  fitToAll(true);
}

/* ---------- Anim + Physics ---------- */
function toggleAnim(fromQuick){
  anim = !anim;
  document.getElementById("btnAnim").textContent = "Animar: " + (anim ? "ON" : "OFF");
  if(fromQuick) renderSide();
}
function autoOrganize(){
  const cx=W/2, cy=H/2;
  const R = Math.min(W,H)*0.30;
  const n = state.nodes.length || 1;
  state.nodes.forEach((node,i)=>{
    const a = (i/n)*Math.PI*2;
    node.x = cx + Math.cos(a)*R + (Math.random()-.5)*30;
    node.y = cy + Math.sin(a)*R + (Math.random()-.5)*30;
    node.vx = (Math.random()-.5)*1.6;
    node.vy = (Math.random()-.5)*1.6;
    node.fx=null; node.fy=null;
  });
  persist();
  fitToAll(true);
  renderAll();
}

function groupMap(){
  const map = new Map();
  for(const n of state.nodes){
    const g = (n.group || "").trim();
    if(!g) continue;
    if(!map.has(g)) map.set(g, []);
    map.get(g).push(n.id);
  }
  return map;
}

function organizeByGroups(){
  const groups = groupMap();
  if(groups.size === 0){
    alert("Nenhum ‘Grupo’ preenchido ainda. Edite as pessoas e preencha o campo Grupo.");
    return;
  }
  const cx=W/2, cy=H/2;
  const G = [...groups.keys()];
  const bigR = Math.min(W,H)*0.30;
  const gCenters = new Map();

  // place group centers in a big ring
  G.forEach((g,i)=>{
    const a = (i/G.length)*Math.PI*2;
    gCenters.set(g, {
      x: cx + Math.cos(a)*bigR,
      y: cy + Math.sin(a)*bigR
    });
  });

  // place nodes around each group center
  for(const [g, ids] of groups.entries()){
    const center = gCenters.get(g);
    const localR = Math.min(220, 90 + ids.length*12);
    ids.forEach((id, i)=>{
      const n = getNode(id);
      if(!n) return;
      const a = (i/ids.length)*Math.PI*2;
      n.x = center.x + Math.cos(a)*localR + (Math.random()-.5)*12;
      n.y = center.y + Math.sin(a)*localR + (Math.random()-.5)*12;
      n.vx = (Math.random()-.5)*1.2;
      n.vy = (Math.random()-.5)*1.2;
      n.fx=null; n.fy=null;
    });
  }

  // nodes without group: push them to center
  state.nodes.filter(n=>!(n.group||"").trim()).forEach((n,i)=>{
    n.x = cx + (Math.random()-.5)*160;
    n.y = cy + (Math.random()-.5)*120;
    n.vx = (Math.random()-.5)*1.2;
    n.vy = (Math.random()-.5)*1.2;
  });

  persist();
  fitToAll(true);
  renderAll();
}

/* physics tuned */
function tick(dt){
  if(state.nodes.length===0) return;

  const repelK = 12000;
  const repelMin = (state.nodes.length>40) ? 55 : 70;
  const springK = 0.010;
  const springLen = (state.nodes.length>40) ? 210 : 240;
  const centerK = 0.0018;
  const damping = 0.92;
  const maxV = 6.0;

  for(let i=0;i<state.nodes.length;i++){
    for(let j=i+1;j<state.nodes.length;j++){
      const a=state.nodes[i], b=state.nodes[j];
      const dx=a.x-b.x, dy=a.y-b.y;
      let d2 = dx*dx+dy*dy;
      if(d2 < 0.0001) d2 = 0.0001;
      const d = Math.sqrt(d2);

      const min = repelMin;
      const strength = (d < min) ? repelK*1.8 : repelK;

      const f = strength / d2;
      const fx = (dx/d)*f;
      const fy = (dy/d)*f;

      if(a.fx==null){ a.vx += fx*dt; a.vy += fy*dt; }
      if(b.fx==null){ b.vx -= fx*dt; b.vy -= fy*dt; }
    }
  }

  state.links.forEach(l=>{
    const a=getNode(l.from), b=getNode(l.to);
    if(!a||!b) return;
    const dx=b.x-a.x, dy=b.y-a.y;
    const dist = Math.sqrt(dx*dx+dy*dy) || 1;

    const w = Number(l.weight||3);
    const target = springLen - (w-3)*18;
    const k = springK * (0.7 + w*0.25);

    const diff = dist - target;
    const fx = (dx/dist) * diff * k;
    const fy = (dy/dist) * diff * k;

    if(a.fx==null){ a.vx += fx*dt; a.vy += fy*dt; }
    if(b.fx==null){ b.vx -= fx*dt; b.vy -= fy*dt; }
  });

  const cx=W/2, cy=H/2;
  state.nodes.forEach(n=>{
    if(n.fx!=null && n.fy!=null){
      n.x = n.fx; n.y = n.fy;
      n.vx *= 0.45; n.vy *= 0.45;
      return;
    }

    n.vx += (cx - n.x) * centerK * dt;
    n.vy += (cy - n.y) * centerK * dt;

    n.vx *= damping;
    n.vy *= damping;

    n.vx = Math.max(-maxV, Math.min(maxV, n.vx));
    n.vy = Math.max(-maxV, Math.min(maxV, n.vy));

    n.x += n.vx;
    n.y += n.vy;

    const pad = 40;
    if(n.x < pad){ n.x=pad; n.vx *= -0.55; }
    if(n.x > W-pad){ n.x=W-pad; n.vx *= -0.55; }
    if(n.y < pad){ n.y=pad; n.vy *= -0.55; }
    if(n.y > H-pad){ n.y=H-pad; n.vy *= -0.55; }
  });
}

/* main loop */
function start(){
  if(raf) cancelAnimationFrame(raf);
  lastT = performance.now();
  const loop = (t)=>{
    const rawDt = (t - lastT);
    lastT = t;
    const dt = Math.max(0.6, Math.min(1.6, rawDt/16.6));
    if(anim) tick(dt);
    renderGraph();
    raf = requestAnimationFrame(loop);
  };
  raf = requestAnimationFrame(loop);
}

/* ---------- Fit / focus ---------- */
function fitToAll(animate){
  if(state.nodes.length===0){
    zoom=1; pan.x=0; pan.y=0;
    return;
  }
  let minX=Infinity, minY=Infinity, maxX=-Infinity, maxY=-Infinity;
  state.nodes.forEach(n=>{
    minX=Math.min(minX, n.x);
    minY=Math.min(minY, n.y);
    maxX=Math.max(maxX, n.x);
    maxY=Math.max(maxY, n.y);
  });

  const pad = 90;
  const bw = (maxX-minX) + pad*2;
  const bh = (maxY-minY) + pad*2;

  const zx = W / bw;
  const zy = H / bh;
  const z = Math.max(0.55, Math.min(1.9, Math.min(zx, zy)));

  const cx = (minX+maxX)/2;
  const cy = (minY+maxY)/2;

  const targetPanX = (W/2 - cx) * z;
  const targetPanY = (H/2 - cy) * z;

  if(!animate){
    zoom = z; pan.x = targetPanX; pan.y = targetPanY;
    return;
  }

  const z0=zoom, px0=pan.x, py0=pan.y;
  const steps = 16;
  let i=0;
  const it = ()=>{
    i++;
    const k = i/steps;
    const ease = 1 - Math.pow(1-k, 3);
    zoom = z0 + (z - z0)*ease;
    pan.x = px0 + (targetPanX - px0)*ease;
    pan.y = py0 + (targetPanY - py0)*ease;
    renderGraph();
    if(i<steps) requestAnimationFrame(it);
  };
  it();
}
function focusNode(id, animate){
  const n = getNode(id);
  if(!n) return;
  const targetPanX = (W/2 - n.x) * zoom;
  const targetPanY = (H/2 - n.y) * zoom;

  if(!animate){
    pan.x = targetPanX; pan.y = targetPanY;
    return;
  }
  const px0=pan.x, py0=pan.y;
  const steps=14;
  let i=0;
  const it=()=>{
    i++;
    const k=i/steps;
    const ease = 1 - Math.pow(1-k, 3);
    pan.x = px0 + (targetPanX - px0)*ease;
    pan.y = py0 + (targetPanY - py0)*ease;
    renderGraph();
    if(i<steps) requestAnimationFrame(it);
  };
  it();
}

/* ---------- Dragging ---------- */
function pointerToGraph(ev){
  const rect = svg.getBoundingClientRect();
  const isTouch = ev.touches && ev.touches[0];
  const clientX = isTouch ? ev.touches[0].clientX : ev.clientX;
  const clientY = isTouch ? ev.touches[0].clientY : ev.clientY;
  const x = (clientX - rect.left) * (W / rect.width);
  const y = (clientY - rect.top) * (H / rect.height);
  const gx = (x - pan.x) / zoom;
  const gy = (y - pan.y) / zoom;
  return {x:gx, y:gy};
}
function startDrag(ev, id){
  ev.preventDefault();
  const n = getNode(id);
  if(!n) return;
  dragging = {id};

  const pt = pointerToGraph(ev);
  n.fx = pt.x;
  n.fy = pt.y;

  window.addEventListener("mousemove", onDragMove);
  window.addEventListener("mouseup", onDragEnd);
  window.addEventListener("touchmove", onDragMove, {passive:false});
  window.addEventListener("touchend", onDragEnd);
}
function onDragMove(ev){
  if(!dragging) return;
  ev.preventDefault();
  const n = getNode(dragging.id);
  if(!n) return;
  const pt = pointerToGraph(ev);
  n.fx = pt.x;
  n.fy = pt.y;
}
function onDragEnd(){
  if(!dragging) return;
  const n = getNode(dragging.id);
  if(n){
    n.x = n.fx; n.y = n.fy;
    n.fx = null; n.fy = null;
    persist();
  }
  dragging = null;
  window.removeEventListener("mousemove", onDragMove);
  window.removeEventListener("mouseup", onDragEnd);
  window.removeEventListener("touchmove", onDragMove);
  window.removeEventListener("touchend", onDragEnd);
}

/* ---------- init save indicator ---------- */
btnShowDetails.disabled = true;
document.getElementById("btnAnim").textContent = "Animar: ON";
try{
  localStorage.setItem("__t","1");
  localStorage.removeItem("__t");
  setSaved(true);
}catch{
  setSaved(false, "Storage bloqueado — use JSON");
}
persist();
</script>
</body>
</html>
