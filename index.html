<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IntegraProjetos — Rede de Integração</title>
  <meta name="theme-color" content="#111827"/>

  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f1a2e;
      --card:#101c33;
      --stroke:rgba(255,255,255,.10);
      --stroke2:rgba(255,255,255,.18);
      --txt:#e5e7eb;
      --muted:#a9b4c2;
      --brand:#7c3aed;
      --brand2:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
      --shadow: 0 18px 45px rgba(0,0,0,.35);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif;
      background: radial-gradient(1200px 700px at 15% 10%, rgba(124,58,237,.25), transparent 55%),
                  radial-gradient(900px 600px at 85% 20%, rgba(34,197,94,.18), transparent 55%),
                  radial-gradient(900px 600px at 50% 85%, rgba(245,158,11,.12), transparent 60%),
                  var(--bg);
      color:var(--txt);
      overflow:hidden;
    }

    .topbar{
      position:fixed; inset:14px 14px auto 14px;
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      background:rgba(15,26,46,.66);
      border:1px solid var(--stroke);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding:10px 12px;
      box-shadow: var(--shadow);
      z-index:50;
      flex-wrap:wrap;
    }
    .brand{display:flex; align-items:center; gap:10px; min-width:260px}
    .logo{
      width:36px; height:36px; border-radius:12px;
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,.30), transparent 55%),
        linear-gradient(135deg, rgba(124,58,237,.95), rgba(34,197,94,.85));
      display:grid; place-items:center;
      border:1px solid rgba(255,255,255,.15);
    }
    .brand h1{font-size:14px; margin:0; letter-spacing:.3px}
    .brand p{margin:0; font-size:12px; color:var(--muted)}
    .actions{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end}

    button{
      appearance:none; border:1px solid var(--stroke);
      background:rgba(16,28,51,.7);
      color:var(--txt);
      border-radius:12px;
      padding:9px 10px;
      font-weight:650;
      font-size:12px;
      cursor:pointer;
      transition: transform .05s ease, border-color .2s ease, background .2s ease;
      user-select:none;
    }
    button:hover{border-color:var(--stroke2)}
    button:active{transform: translateY(1px)}
    .btn-primary{
      background: linear-gradient(135deg, rgba(124,58,237,.92), rgba(34,197,94,.75));
      border-color: rgba(255,255,255,.18);
    }
    .btn-danger{ border-color: rgba(239,68,68,.35); background: rgba(239,68,68,.10); }
    .btn-warn{ border-color: rgba(245,158,11,.35); background: rgba(245,158,11,.10); }

    .wrap{
      position:fixed; inset:0;
      display:grid;
      grid-template-columns: 1fr 380px;
      gap:0;
    }

    #stage{
      position:relative;
      margin-top: 76px;
      margin-left: 14px;
      margin-bottom: 14px;
      margin-right: 7px;
      border-radius: 18px;
      border:1px solid var(--stroke);
      background: rgba(8,14,26,.35);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .side{
      margin-top: 76px;
      margin-right: 14px;
      margin-bottom: 14px;
      margin-left: 7px;
      border-radius: 18px;
      border:1px solid var(--stroke);
      background: rgba(15,26,46,.66);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-width: 320px;
    }
    .side header{
      padding:12px 12px 10px;
      border-bottom:1px solid var(--stroke);
      display:flex; gap:10px; align-items:center; justify-content:space-between;
    }
    .side header h2{margin:0; font-size:13px}
    .side header .small{font-size:12px; color:var(--muted)}
    .side .content{padding:12px; overflow:auto}

    .pill{
      display:inline-flex; gap:6px; align-items:center;
      border:1px solid var(--stroke);
      background:rgba(16,28,51,.55);
      padding:6px 8px; border-radius:999px; font-size:12px; color:var(--muted);
    }

    .grid{display:grid; gap:10px;}
    .field{display:grid; gap:6px;}
    label{font-size:12px; color:var(--muted)}
    input[type="text"], textarea, select{
      width:100%;
      border-radius: 12px;
      border:1px solid var(--stroke);
      background: rgba(16,28,51,.65);
      color: var(--txt);
      padding:10px 10px;
      outline:none;
      font-size:13px;
    }
    textarea{min-height:78px; resize: vertical;}
    .row{display:flex; gap:8px}
    .row > *{flex:1}
    .hint{font-size:12px; color:var(--muted); line-height:1.35}
    .sep{height:1px; background:var(--stroke); margin:10px 0}

    .list{display:grid; gap:8px;}
    .mini{
      border:1px solid var(--stroke);
      background: rgba(16,28,51,.45);
      border-radius: 14px;
      padding:10px;
    }
    .mini b{display:block; font-size:13px; margin-bottom:4px}
    .mini .meta{font-size:12px; color:var(--muted)}
    .mini .k{display:inline-block; margin-right:8px; font-size:12px; color:var(--muted)}
    .mini .actions2{display:flex; gap:8px; margin-top:10px; flex-wrap:wrap}
    .mini .actions2 button{padding:7px 9px; border-radius:11px}

    /* Modal compatível (sem <dialog>) */
    .modal{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      place-items:center;
      z-index:80;
      padding:12px;
    }
    .modal[open]{display:grid}
    .modal .box{
      width:min(780px, calc(100vw - 24px));
      max-height: min(86vh, 900px);
      overflow:auto;
      border-radius: 18px;
      border:1px solid var(--stroke);
      background: rgba(15,26,46,.92);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      padding:12px;
    }
    .box header{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:6px 6px 10px;
      border-bottom:1px solid var(--stroke);
    }
    .box header h3{margin:0; font-size:14px}
    .box .body{padding:10px 6px 6px}

    .legend{
      position:absolute; left:12px; bottom:12px;
      display:flex; gap:8px; flex-wrap:wrap;
      z-index:10;
      pointer-events:none;
    }
    .legend .tag{
      display:inline-flex; align-items:center; gap:8px;
      padding:7px 9px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(15,26,46,.62);
      font-size:12px;
      color:var(--muted);
      backdrop-filter: blur(8px);
    }
    .dot{
      width:10px; height:10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.20);
      background: rgba(124,58,237,.9);
    }

    @media (max-width: 980px){
      .wrap{grid-template-columns:1fr}
      .side{
        position:fixed; inset:auto 14px 14px 14px;
        height: 44vh;
        margin:0;
        z-index:60;
      }
      #stage{
        margin-right:14px;
        margin-bottom: calc(44vh + 22px);
      }
      .brand{min-width:unset}
    }
  </style>
</head>
<body>

  <div class="topbar">
    <div class="brand">
      <div class="logo" aria-hidden="true">●</div>
      <div>
        <h1>IntegraProjetos — Rede visual de integração</h1>
        <p>Arraste as bolinhas • clique para ver/editar • crie ligações com motivo, perguntas e resultados</p>
      </div>
    </div>

    <div class="actions">
      <button class="btn-primary" id="btnAdd">+ Adicionar pessoa</button>
      <button id="btnAuto">Auto-organizar</button>
      <button id="btnClearSel">Limpar seleção</button>
      <button id="btnExportJson">Baixar JSON</button>
      <button id="btnExportSvg">Baixar SVG</button>
      <button class="btn-warn" id="btnImport">Importar JSON</button>
      <button class="btn-danger" id="btnReset">Resetar tudo</button>
    </div>
  </div>

  <div class="wrap">
    <div id="stage">
      <svg id="svg" width="100%" height="100%" viewBox="0 0 1200 800" preserveAspectRatio="none"></svg>

      <div class="legend" aria-hidden="true">
        <span class="tag"><span class="dot" style="background:rgba(124,58,237,.95)"></span>Ligação: dados/integração</span>
        <span class="tag"><span class="dot" style="background:rgba(34,197,94,.95)"></span>Ligação: produto/jogo</span>
        <span class="tag"><span class="dot" style="background:rgba(245,158,11,.95)"></span>Ligação: extensão/visibilidade</span>
        <span class="tag"><span class="dot" style="background:rgba(96,165,250,.95)"></span>Ligação: análise científica</span>
      </div>
    </div>

    <aside class="side">
      <header>
        <div>
          <h2 id="sideTitle">Selecione uma pessoa</h2>
          <div class="small" id="sideSub">Clique numa bolinha para ver detalhes e criar ligações.</div>
        </div>
        <span class="pill" id="countPill">0 pessoas</span>
      </header>

      <div class="content" id="sideContent">
        <div class="hint">
          Dica: <b>arraste</b> as bolinhas para posicionar. Use <b>“Criar ligação”</b> no painel para definir:
          <i>por quê liga</i>, <i>tipo</i>, <i>perguntas</i> e <i>resultados esperados</i>.
        </div>

        <div class="sep"></div>

        <div class="field">
          <label>Buscar pessoa</label>
          <input type="text" id="search" placeholder="Ex.: Letícia, carbono, jogos..." />
        </div>

        <div class="row" style="margin-top:10px">
          <div class="field">
            <label>Filtrar por nível</label>
            <select id="filterLevel">
              <option value="">Todos</option>
              <option>Graduação</option>
              <option>Mestrado</option>
              <option>Doutorado</option>
              <option>Pós-doutorado</option>
              <option>Professor</option>
              <option>Colaborador</option>
            </select>
          </div>
          <div class="field">
            <label>Filtrar por área</label>
            <select id="filterArea">
              <option value="">Todas</option>
              <option>Clima & Saúde</option>
              <option>Extensão & Visibilidade</option>
              <option>Atividade Física & Ambiente</option>
              <option>Carbono (dados)</option>
              <option>Carbono (processos)</option>
              <option>Jogos & Educação</option>
            </select>
          </div>
        </div>

        <div class="sep"></div>

        <div class="list" id="peopleList"></div>
      </div>
    </aside>
  </div>

  <!-- Modal: Add/Edit Person -->
  <div class="modal" id="modalPerson">
    <div class="box">
      <header>
        <h3 id="modalPersonTitle">Adicionar pessoa</h3>
        <div style="display:flex; gap:8px">
          <button id="btnClosePerson">Fechar</button>
          <button class="btn-primary" id="btnSavePerson">Salvar</button>
        </div>
      </header>
      <div class="body">
        <div class="grid">
          <div class="row">
            <div class="field">
              <label>Nome</label>
              <input type="text" id="p_name" placeholder="Ex.: Letícia Zen" />
            </div>
            <div class="field">
              <label>Nível</label>
              <select id="p_level">
                <option>Graduação</option>
                <option>Mestrado</option>
                <option>Doutorado</option>
                <option>Pós-doutorado</option>
                <option>Professor</option>
                <option>Colaborador</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label>Área (categoria)</label>
              <select id="p_area">
                <option>Clima & Saúde</option>
                <option>Extensão & Visibilidade</option>
                <option>Atividade Física & Ambiente</option>
                <option>Carbono (dados)</option>
                <option>Carbono (processos)</option>
                <option>Jogos & Educação</option>
              </select>
            </div>
            <div class="field">
              <label>Cor da bolinha (hex ou rgba)</label>
              <input type="text" id="p_color" placeholder="Ex.: rgba(124,58,237,.95) ou #22c55e" />
            </div>
          </div>

          <div class="field">
            <label>Título do trabalho (curto)</label>
            <input type="text" id="p_title" placeholder="Ex.: Impacto do calor na mortalidade em MT" />
          </div>

          <div class="field">
            <label>Objetivos</label>
            <textarea id="p_objectives" placeholder="Descreva objetivos e escopo..."></textarea>
          </div>

          <div class="field">
            <label>Resultados esperados</label>
            <textarea id="p_expected" placeholder="Ex.: planilhas organizadas, gráficos, jogo 3D..."></textarea>
          </div>

          <div class="field">
            <label>Tags (separe por vírgula)</label>
            <input type="text" id="p_tags" placeholder="Ex.: planilhas, gráficos, mortalidade, carbono, jogos" />
          </div>

          <div class="hint">Tudo é editável e você pode excluir depois. Exporta/Importa via JSON.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Create/Edit Link -->
  <div class="modal" id="modalLink">
    <div class="box">
      <header>
        <h3 id="modalLinkTitle">Criar ligação</h3>
        <div style="display:flex; gap:8px">
          <button id="btnCloseLink">Fechar</button>
          <button class="btn-primary" id="btnSaveLink">Salvar ligação</button>
        </div>
      </header>
      <div class="body">
        <div class="grid">
          <div class="row">
            <div class="field">
              <label>De (origem)</label>
              <select id="l_from"></select>
            </div>
            <div class="field">
              <label>Para (destino)</label>
              <select id="l_to"></select>
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label>Tipo de ligação</label>
              <select id="l_type">
                <option value="dados">Dados / Integração</option>
                <option value="analise">Análise científica</option>
                <option value="extensao">Extensão / Visibilidade</option>
                <option value="produto">Produto / Jogo</option>
                <option value="campo">Coleta / Campo</option>
                <option value="outro">Outro</option>
              </select>
            </div>
            <div class="field">
              <label>Intensidade (1–5)</label>
              <select id="l_weight">
                <option>1</option><option>2</option><option selected>3</option><option>4</option><option>5</option>
              </select>
            </div>
          </div>

          <div class="field">
            <label>Por que liga?</label>
            <textarea id="l_reason"></textarea>
          </div>

          <div class="field">
            <label>Perguntas</label>
            <textarea id="l_questions"></textarea>
          </div>

          <div class="field">
            <label>Resultados esperados da ligação</label>
            <textarea id="l_outputs"></textarea>
          </div>

          <div class="field">
            <label>Links/arquivos (uma URL por linha)</label>
            <textarea id="l_files" placeholder="https://..."></textarea>
          </div>
        </div>
      </div>
    </div>
  </div>

  <input type="file" id="fileImport" accept="application/json" style="display:none"/>

<script>
/* =========================
   Fix principal:
   - Sem structuredClone (compatível Android)
   - Modal sem <dialog>
========================= */

const STORAGE_KEY = "integraprojetos_v1";

/* ---- util ---- */
function uid(){
  return "id_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
}
function deepClone(obj){
  // compatível com qualquer browser
  return JSON.parse(JSON.stringify(obj));
}
function clamp(v, a, b){ return Math.max(a, Math.min(b, v)); }
function escapeHTML(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function linkColor(type){
  switch(type){
    case "dados": return "rgba(124,58,237,.95)";
    case "produto": return "rgba(34,197,94,.95)";
    case "extensao": return "rgba(245,158,11,.95)";
    case "analise": return "rgba(96,165,250,.95)";
    case "campo": return "rgba(239,68,68,.85)";
    default: return "rgba(229,231,235,.35)";
  }
}
function shortType(type){
  switch(type){
    case "dados": return "dados";
    case "produto": return "produto";
    case "extensao": return "extensão";
    case "analise": return "análise";
    case "campo": return "campo";
    default: return "outro";
  }
}
function longType(type){
  switch(type){
    case "dados": return "Dados / Integração";
    case "produto": return "Produto / Jogo";
    case "extensao": return "Extensão / Visibilidade";
    case "analise": return "Análise científica";
    case "campo": return "Coleta / Campo";
    default: return "Outro";
  }
}
function downloadBlob(text, filename, mime){
  const blob = new Blob([text], {type:mime});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 800);
}

/* ---- Seed (os 7 alunos que você passou) ---- */
const SEED = {
  meta: { app: "IntegraProjetos", version: 1, updatedAt: new Date().toISOString() },
  nodes: [
    { id: uid(), name:"Letícia Zen", level:"Graduação", area:"Clima & Saúde",
      title:"Impacto do calor na mortalidade em MT (dados secundários)",
      objectives:"Trabalha com análise de dados secundários sobre o impacto do calor na mortalidade em MT.",
      expected:"Organização de planilhas e produção de gráficos comparativos e analíticos.",
      tags:["mortalidade","calor","planilhas","gráficos","MT"], color:"rgba(96,165,250,.95)"
    },
    { id: uid(), name:"Cintya", level:"Graduação", area:"Extensão & Visibilidade",
      title:"Extensão na pós: visibilidade e identificação de projetos",
      objectives:"Produção de dados sobre a extensão na pós-graduação, com análise e identificação de projetos para dar visibilidade à pós-graduação.",
      expected:"Identificação de projetos para a visibilidade da pós da UNEMAT.",
      tags:["extensão","pós-graduação","visibilidade","mapeamento"], color:"rgba(245,158,11,.95)"
    },
    { id: uid(), name:"Antônio", level:"Graduação", area:"Atividade Física & Ambiente",
      title:"Efeito da temperatura em atividade física (aberto/fechado/escolas)",
      objectives:"Avalia o efeito da temperatura em atividades físicas de áreas abertas, fechadas e em escolas.",
      expected:"Coleta de dados em diferentes ambientes em Cáceres; organização de planilhas; análises e comparações térmicas entre ambientes.",
      tags:["temperatura","atividade física","Cáceres","campo","comparação"], color:"rgba(34,197,94,.95)"
    },
    { id: uid(), name:"Luan", level:"Graduação", area:"Jogos & Educação",
      title:"Jogo interativo sobre carbono (rumo ao 3D)",
      objectives:"Produção de jogos interativos sobre o carbono; analisa itens necessários para produção do jogo.",
      expected:"Produzir um jogo 3D sobre carbono.",
      tags:["jogos","carbono","3D","educação"], color:"rgba(124,58,237,.95)"
    },
    { id: uid(), name:"Matheus", level:"Graduação", area:"Carbono (dados)",
      title:"Inspetor/organizador de planilhas do laboratório (carbono)",
      objectives:"Organização de dados de carbono em planilhas; atua como inspetor de dados e integração de planilhas do lab.",
      expected:"Todas as planilhas deverão ser revisadas por ele para integração de dados.",
      tags:["planilhas","carbono","integração","qualidade"], color:"rgba(16,185,129,.95)"
    },
    { id: uid(), name:"Leandro", level:"Graduação", area:"Carbono (processos)",
      title:"ATTZ e dinâmica do carbono na praia de Cáceres",
      objectives:"Analisa a influência da ATTZ na dinâmica do carbono em praia de Cáceres.",
      expected:"Identificar a dinâmica das águas e sua influência no fluxo de CO₂ de áreas alagáveis até secas.",
      tags:["ATTZ","CO2","hidrodinâmica","Cáceres","alagável"], color:"rgba(59,130,246,.95)"
    },
    { id: uid(), name:"Vanessa", level:"Graduação", area:"Jogos & Educação",
      title:"Jogos físicos + Guardiões do Clima (ensino médio)",
      objectives:"Produção de jogos físicos para integração com estudantes do ensino médio; monitora dos Guardiões do Clima.",
      expected:"Produzir jogos sobre carbono e mudanças climáticas para crianças e adolescentes.",
      tags:["jogos físicos","ensino médio","clima","carbono"], color:"rgba(236,72,153,.92)"
    }
  ],
  links: []
};

function mkLink(fromName, toName, type, weight, reason, questions, outputs, filesText){
  const from = SEED.nodes.find(n => n.name.toLowerCase() === fromName.toLowerCase());
  const to = SEED.nodes.find(n => n.name.toLowerCase() === toName.toLowerCase());
  if(!from || !to) return null;
  return { id: uid(), from: from.id, to: to.id, type, weight, reason, questions, outputs,
    files: (filesText||"").split("\n").map(s=>s.trim()).filter(Boolean)
  };
}
SEED.links = [
  mkLink("Matheus","Letícia Zen","dados",4,
    "Matheus padroniza e integra planilhas que alimentam análises de Letícia.",
    "Quais variáveis entram? Qual período? Qual padrão de colunas e unidades?",
    "Dataset unificado + dicionário de dados + planilha final pronta para gráficos.",
    ""
  ),
  mkLink("Luan","Vanessa","produto",3,
    "Integração entre jogos digitais e jogos físicos (mesma narrativa pedagógica).",
    "Qual faixa etária? Quais mecânicas e objetivos pedagógicos?",
    "Protótipo digital + kit físico alinhado em conteúdo e avaliação.",
    ""
  ),
  mkLink("Leandro","Matheus","dados",3,
    "Leandro gera séries/processos que entram no padrão de integração do laboratório.",
    "Campos mínimos? Metadados? Unidades? Como versionar?",
    "Planilha padronizada de processos + metadados completos.",
    ""
  ),
  mkLink("Antônio","Cintya","extensao",2,
    "Resultados de escolas podem virar ação de extensão/visibilidade na pós.",
    "Como transformar em atividade/mostra e material de divulgação?",
    "Relato de extensão + indicadores simples e comunicáveis.",
    ""
  )
].filter(Boolean);

/* ---- State ---- */
let state = loadState();
let selectedNodeId = null;
let editingPersonId = null;
let editingLinkId = null;

/* ---- DOM ---- */
const svg = document.getElementById("svg");
const stage = document.getElementById("stage");
const countPill = document.getElementById("countPill");
const peopleList = document.getElementById("peopleList");
const search = document.getElementById("search");
const filterLevel = document.getElementById("filterLevel");
const filterArea = document.getElementById("filterArea");
const sideTitle = document.getElementById("sideTitle");
const sideSub = document.getElementById("sideSub");
const sideContent = document.getElementById("sideContent");

const modalPerson = document.getElementById("modalPerson");
const modalPersonTitle = document.getElementById("modalPersonTitle");
const p_name = document.getElementById("p_name");
const p_level = document.getElementById("p_level");
const p_area = document.getElementById("p_area");
const p_color = document.getElementById("p_color");
const p_title = document.getElementById("p_title");
const p_objectives = document.getElementById("p_objectives");
const p_expected = document.getElementById("p_expected");
const p_tags = document.getElementById("p_tags");

const modalLink = document.getElementById("modalLink");
const modalLinkTitle = document.getElementById("modalLinkTitle");
const l_from = document.getElementById("l_from");
const l_to = document.getElementById("l_to");
const l_type = document.getElementById("l_type");
const l_weight = document.getElementById("l_weight");
const l_reason = document.getElementById("l_reason");
const l_questions = document.getElementById("l_questions");
const l_outputs = document.getElementById("l_outputs");
const l_files = document.getElementById("l_files");

document.getElementById("btnAdd").addEventListener("click", () => openPersonModal(null));
document.getElementById("btnAuto").addEventListener("click", () => { autoNudge(); persist(); });
document.getElementById("btnClearSel").addEventListener("click", () => { selectedNodeId = null; renderAll(); });
document.getElementById("btnExportJson").addEventListener("click", exportJSON);
document.getElementById("btnExportSvg").addEventListener("click", exportSVG);
document.getElementById("btnImport").addEventListener("click", () => document.getElementById("fileImport").click());
document.getElementById("btnReset").addEventListener("click", resetAll);

document.getElementById("btnClosePerson").addEventListener("click", () => closeModal(modalPerson));
document.getElementById("btnSavePerson").addEventListener("click", savePersonFromModal);
document.getElementById("btnCloseLink").addEventListener("click", () => closeModal(modalLink));
document.getElementById("btnSaveLink").addEventListener("click", saveLinkFromModal);
document.getElementById("fileImport").addEventListener("change", importJSONFile);

search.addEventListener("input", renderPeopleList);
filterLevel.addEventListener("change", renderPeopleList);
filterArea.addEventListener("change", renderPeopleList);

/* ---- SVG layers ---- */
function makeSvg(tag, attrs={}){
  const el = document.createElementNS("http://www.w3.org/2000/svg", tag);
  for(const [k,v] of Object.entries(attrs)) el.setAttribute(k, v);
  return el;
}
const gLinks = makeSvg("g", { id:"gLinks" });
const gNodes = makeSvg("g", { id:"gNodes" });
svg.appendChild(gLinks);
svg.appendChild(gNodes);

/* ---- ViewBox size ---- */
let view = { w:1200, h:800 };
resizeSVG();
window.addEventListener("resize", resizeSVG);

/* ---- init positions + sim ---- */
initPositions();
startSim();

/* ---- render ---- */
renderAll();

/* =======================
   Core
======================= */
function loadState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return deepClone(SEED);
    const obj = JSON.parse(raw);
    if(!obj.nodes || !Array.isArray(obj.nodes)) return deepClone(SEED);
    // normalize
    return {
      meta: obj.meta || { app:"IntegraProjetos", version:1, updatedAt:new Date().toISOString() },
      nodes: obj.nodes.map(n => ({
        id: n.id || uid(),
        name: n.name || "Sem nome",
        level: n.level || "Graduação",
        area: n.area || "Clima & Saúde",
        title: n.title || "",
        objectives: n.objectives || "",
        expected: n.expected || "",
        tags: Array.isArray(n.tags) ? n.tags : [],
        color: n.color || "rgba(124,58,237,.95)",
        x: Number.isFinite(n.x) ? n.x : 0,
        y: Number.isFinite(n.y) ? n.y : 0,
        vx: n.vx ?? 0, vy: n.vy ?? 0,
        fx: null, fy: null
      })),
      links: (obj.links||[]).map(l => ({
        id: l.id || uid(),
        from: l.from, to: l.to,
        type: l.type || "dados",
        weight: Number(l.weight || 3),
        reason: l.reason || "",
        questions: l.questions || "",
        outputs: l.outputs || "",
        files: Array.isArray(l.files) ? l.files : []
      }))
    };
  }catch(e){
    // fallback total
    return deepClone(SEED);
  }
}

function persist(){
  try{
    state.meta.updatedAt = new Date().toISOString();
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  }catch(e){
    alert("Não consegui salvar no navegador (armazenamento cheio ou bloqueado).");
  }
}

function getNode(id){ return state.nodes.find(n => n.id === id); }

function initPositions(force=false){
  state.nodes.forEach(n => {
    const bad = !Number.isFinite(n.x) || !Number.isFinite(n.y) || n.x===0 || n.y===0;
    if(force || bad){
      n.x = view.w/2 + (Math.random()-.5)*360;
      n.y = view.h/2 + (Math.random()-.5)*240;
      n.vx = (Math.random()-.5)*1.2;
      n.vy = (Math.random()-.5)*1.2;
    }
  });
}

function resizeSVG(){
  const rect = stage.getBoundingClientRect();
  view.w = Math.max(700, Math.floor(rect.width));
  view.h = Math.max(520, Math.floor(rect.height));
  svg.setAttribute("viewBox", `0 0 ${view.w} ${view.h}`);
}

function renderAll(){
  countPill.textContent = `${state.nodes.length} pessoas`;
  renderPeopleList();
  renderGraph();
  renderSide();
}

function renderPeopleList(){
  const q = (search.value || "").trim().toLowerCase();
  const lvl = filterLevel.value;
  const area = filterArea.value;

  const filtered = state.nodes
    .filter(n => !lvl || n.level === lvl)
    .filter(n => !area || n.area === area)
    .filter(n => {
      if(!q) return true;
      const hay = `${n.name} ${n.level} ${n.area} ${n.title} ${(n.tags||[]).join(" ")}`.toLowerCase();
      return hay.includes(q);
    })
    .sort((a,b)=> a.name.localeCompare(b.name, "pt-BR"));

  peopleList.innerHTML = "";
  filtered.forEach(n => {
    const el = document.createElement("div");
    el.className = "mini";
    el.innerHTML = `
      <b>${escapeHTML(n.name)}</b>
      <div class="meta">${escapeHTML(n.level)} • ${escapeHTML(n.area)}</div>
      <div class="meta" style="margin-top:6px">${escapeHTML(n.title || "")}</div>
      <div class="actions2">
        <button data-act="focus">Focar</button>
        <button data-act="edit">Editar</button>
        <button data-act="link">Criar ligação</button>
      </div>
    `;
    el.querySelector('[data-act="focus"]').onclick = () => {
      selectedNodeId = n.id;
      bumpToCenter(n.id);
      renderAll();
    };
    el.querySelector('[data-act="edit"]').onclick = () => openPersonModal(n.id);
    el.querySelector('[data-act="link"]').onclick = () => openLinkModal(null, n.id);

    peopleList.appendChild(el);
  });
}

function renderGraph(){
  gLinks.innerHTML = "";
  gNodes.innerHTML = "";

  // links
  state.links.forEach(link => {
    const a = getNode(link.from);
    const b = getNode(link.to);
    if(!a || !b) return;

    const line = makeSvg("line", {
      x1:a.x, y1:a.y, x2:b.x, y2:b.y,
      stroke: linkColor(link.type),
      "stroke-width": Math.max(1.5, Number(link.weight||3) * 1.2),
      "stroke-opacity": selectedNodeId ? ((link.from===selectedNodeId || link.to===selectedNodeId) ? .95 : .18) : .55
    });
    line.style.cursor = "pointer";
    line.addEventListener("click", (e) => {
      e.stopPropagation();
      openLinkModal(link.id);
    });
    gLinks.appendChild(line);

    const mx=(a.x+b.x)/2, my=(a.y+b.y)/2;
    const t = makeSvg("text", {
      x:mx, y:my,
      fill: selectedNodeId && !(link.from===selectedNodeId || link.to===selectedNodeId) ? "rgba(229,231,235,.18)" : "rgba(229,231,235,.75)",
      "font-size":"11",
      "text-anchor":"middle"
    });
    t.textContent = shortType(link.type);
    t.style.pointerEvents = "none";
    gLinks.appendChild(t);
  });

  // nodes
  state.nodes.forEach(node => {
    const r = 18 + (node.tags?.length ? Math.min(10, node.tags.length) : 0);
    const isSel = node.id === selectedNodeId;

    const group = makeSvg("g", { "data-id": node.id });
    group.style.cursor = "grab";

    const halo = makeSvg("circle", {
      cx:node.x, cy:node.y, r:r+10,
      fill:"transparent",
      stroke: isSel ? "rgba(255,255,255,.35)" : "rgba(255,255,255,.08)",
      "stroke-width": isSel ? 2.2 : 1.2
    });
    group.appendChild(halo);

    const c = makeSvg("circle", {
      cx:node.x, cy:node.y, r,
      fill: node.color || "rgba(124,58,237,.95)",
      stroke:"rgba(255,255,255,.18)",
      "stroke-width": isSel ? 2.2 : 1.3
    });
    group.appendChild(c);

    const name = makeSvg("text", {
      x: node.x, y: node.y + r + 16,
      fill: isSel ? "rgba(255,255,255,.92)" : "rgba(229,231,235,.80)",
      "font-size":"13",
      "text-anchor":"middle"
    });
    name.textContent = node.name;
    group.appendChild(name);

    const sub = makeSvg("text", {
      x: node.x, y: node.y + r + 30,
      fill:"rgba(169,180,194,.80)",
      "font-size":"11",
      "text-anchor":"middle"
    });
    sub.textContent = node.area;
    group.appendChild(sub);

    group.addEventListener("mousedown", (e)=>startDrag(e,node.id));
    group.addEventListener("touchstart", (e)=>startDrag(e,node.id), {passive:false});
    group.addEventListener("click", (e)=>{
      e.stopPropagation();
      selectedNodeId = node.id;
      renderAll();
    });

    gNodes.appendChild(group);
  });

  svg.onclick = () => { selectedNodeId = null; renderAll(); };
}

/* ---- Side panel ---- */
function renderSide(){
  const n = selectedNodeId ? getNode(selectedNodeId) : null;
  if(!n){
    sideTitle.textContent = "Selecione uma pessoa";
    sideSub.textContent = "Clique numa bolinha para ver detalhes e criar ligações.";
    // mantém lista já existente
    return;
  }

  sideTitle.textContent = n.name;
  sideSub.textContent = `${n.level} • ${n.area}`;

  const linksOut = state.links.filter(l => l.from===n.id || l.to===n.id);

  sideContent.innerHTML = `
    <div class="grid">
      <div class="mini">
        <div class="meta"><span class="k">Título</span></div>
        <div style="margin-top:6px">${escapeHTML(n.title||"")}</div>
      </div>

      <div class="mini">
        <div class="meta"><span class="k">Objetivos</span></div>
        <div style="margin-top:6px; white-space:pre-wrap">${escapeHTML(n.objectives||"")}</div>
      </div>

      <div class="mini">
        <div class="meta"><span class="k">Resultados esperados</span></div>
        <div style="margin-top:6px; white-space:pre-wrap">${escapeHTML(n.expected||"")}</div>
      </div>

      <div class="mini">
        <div class="meta"><span class="k">Tags</span></div>
        <div style="margin-top:8px; display:flex; gap:6px; flex-wrap:wrap">
          ${(n.tags||[]).map(t => `<span class="pill">${escapeHTML(t)}</span>`).join("") || `<span class="hint">Sem tags.</span>`}
        </div>
      </div>

      <div class="row">
        <button class="btn-primary" id="sideEdit">Editar pessoa</button>
        <button id="sideLink">Criar ligação</button>
      </div>

      <div class="sep"></div>

      <div class="mini">
        <b style="margin-bottom:6px">Ligações (${linksOut.length})</b>
        <div class="hint">Clique numa ligação para editar.</div>
        <div style="height:8px"></div>
        <div class="list" id="sideLinks"></div>
      </div>

      <div class="row">
        <button class="btn-danger" id="sideDelete">Excluir pessoa</button>
        <button id="sideFocus">Focar no mapa</button>
      </div>
    </div>
  `;

  document.getElementById("sideEdit").onclick = () => openPersonModal(n.id);
  document.getElementById("sideLink").onclick = () => openLinkModal(null, n.id);
  document.getElementById("sideDelete").onclick = () => deletePerson(n.id);
  document.getElementById("sideFocus").onclick = () => { bumpToCenter(n.id); renderGraph(); };

  const sideLinks = document.getElementById("sideLinks");
  sideLinks.innerHTML = "";
  linksOut.sort((a,b)=>(Number(b.weight||3)-Number(a.weight||3))).forEach(l=>{
    const otherId = (l.from===n.id) ? l.to : l.from;
    const other = getNode(otherId);
    const box = document.createElement("div");
    box.className = "mini";
    box.innerHTML = `
      <div style="display:flex; justify-content:space-between; gap:10px; align-items:flex-start">
        <div>
          <b>${escapeHTML(other ? other.name : "—")}</b>
          <div class="meta">${escapeHTML(longType(l.type))} • intensidade ${escapeHTML(String(l.weight||3))}</div>
        </div>
        <span class="pill" style="border-color:${linkColor(l.type)}; color:rgba(229,231,235,.88)">${escapeHTML(shortType(l.type))}</span>
      </div>
      <div class="meta" style="margin-top:8px"><span class="k">Por quê</span></div>
      <div style="white-space:pre-wrap; margin-top:4px">${escapeHTML(l.reason||"")}</div>
      <div class="actions2">
        <button data-act="edit">Editar</button>
        <button class="btn-danger" data-act="del">Excluir</button>
      </div>
    `;
    box.querySelector('[data-act="edit"]').onclick = () => openLinkModal(l.id);
    box.querySelector('[data-act="del"]').onclick = () => deleteLink(l.id);
    sideLinks.appendChild(box);
  });
}

/* ---- Modals ---- */
function openModal(m){ m.setAttribute("open",""); }
function closeModal(m){ m.removeAttribute("open"); }

function openPersonModal(id){
  editingPersonId = id;

  if(id){
    const n = getNode(id);
    modalPersonTitle.textContent = "Editar pessoa";
    p_name.value = n.name || "";
    p_level.value = n.level || "Graduação";
    p_area.value = n.area || "Clima & Saúde";
    p_color.value = n.color || "";
    p_title.value = n.title || "";
    p_objectives.value = n.objectives || "";
    p_expected.value = n.expected || "";
    p_tags.value = (n.tags||[]).join(", ");
  }else{
    modalPersonTitle.textContent = "Adicionar pessoa";
    p_name.value = "";
    p_level.value = "Graduação";
    p_area.value = "Clima & Saúde";
    p_color.value = "rgba(124,58,237,.95)";
    p_title.value = "";
    p_objectives.value = "";
    p_expected.value = "";
    p_tags.value = "";
  }

  openModal(modalPerson);
}

function savePersonFromModal(){
  const name = p_name.value.trim();
  if(!name){ alert("Informe o nome."); return; }

  const node = {
    id: editingPersonId || uid(),
    name,
    level: p_level.value,
    area: p_area.value,
    color: p_color.value.trim() || "rgba(124,58,237,.95)",
    title: p_title.value.trim(),
    objectives: p_objectives.value.trim(),
    expected: p_expected.value.trim(),
    tags: p_tags.value.split(",").map(s=>s.trim()).filter(Boolean),
  };

  if(editingPersonId){
    const idx = state.nodes.findIndex(n => n.id === editingPersonId);
    if(idx >= 0){
      const old = state.nodes[idx];
      state.nodes[idx] = { ...old, ...node };
    }
  }else{
    node.x = view.w/2 + (Math.random()-.5)*120;
    node.y = view.h/2 + (Math.random()-.5)*120;
    node.vx = 0; node.vy = 0;
    state.nodes.push(node);
  }

  persist();
  closeModal(modalPerson);
  selectedNodeId = node.id;
  renderAll();
}

function openLinkModal(linkId, defaultFromNodeId){
  editingLinkId = linkId;

  const nodesSorted = [...state.nodes].sort((a,b)=>a.name.localeCompare(b.name,"pt-BR"));
  l_from.innerHTML = nodesSorted.map(n => `<option value="${n.id}">${escapeHTML(n.name)}</option>`).join("");
  l_to.innerHTML = nodesSorted.map(n => `<option value="${n.id}">${escapeHTML(n.name)}</option>`).join("");

  if(linkId){
    const l = state.links.find(x => x.id === linkId);
    modalLinkTitle.textContent = "Editar ligação";
    l_from.value = l.from;
    l_to.value = l.to;
    l_type.value = l.type || "dados";
    l_weight.value = String(l.weight || 3);
    l_reason.value = l.reason || "";
    l_questions.value = l.questions || "";
    l_outputs.value = l.outputs || "";
    l_files.value = (l.files || []).join("\n");
  }else{
    modalLinkTitle.textContent = "Criar ligação";
    const from = defaultFromNodeId || selectedNodeId || (state.nodes[0]?.id);
    const to = state.nodes.find(n => n.id !== from)?.id || from;
    l_from.value = from;
    l_to.value = to;
    l_type.value = "dados";
    l_weight.value = "3";
    l_reason.value = "";
    l_questions.value = "";
    l_outputs.value = "";
    l_files.value = "";
  }

  openModal(modalLink);
}

function saveLinkFromModal(){
  const from = l_from.value;
  const to = l_to.value;
  if(!from || !to || from === to){ alert("Selecione origem e destino diferentes."); return; }

  const link = {
    id: editingLinkId || uid(),
    from, to,
    type: l_type.value,
    weight: Number(l_weight.value || 3),
    reason: l_reason.value.trim(),
    questions: l_questions.value.trim(),
    outputs: l_outputs.value.trim(),
    files: l_files.value.split("\n").map(s=>s.trim()).filter(Boolean)
  };

  if(editingLinkId){
    const idx = state.links.findIndex(l => l.id === editingLinkId);
    if(idx >= 0) state.links[idx] = link;
  }else{
    state.links.push(link);
  }

  persist();
  closeModal(modalLink);
  renderAll();
}

function deleteLink(id){
  if(!confirm("Excluir esta ligação?")) return;
  state.links = state.links.filter(l => l.id !== id);
  persist();
  renderAll();
}

function deletePerson(id){
  const n = getNode(id);
  if(!n) return;
  if(!confirm(`Excluir "${n.name}"? Isso remove as ligações dela.`)) return;

  state.nodes = state.nodes.filter(x => x.id !== id);
  state.links = state.links.filter(l => l.from !== id && l.to !== id);
  if(selectedNodeId === id) selectedNodeId = null;
  persist();
  renderAll();
}

/* ---- Export/Import ---- */
function exportJSON(){
  const out = {
    meta: { app:"IntegraProjetos", version:1, exportedAt:new Date().toISOString() },
    nodes: state.nodes.map(n => ({...n, x:Math.round(n.x), y:Math.round(n.y)})),
    links: state.links
  };
  downloadBlob(JSON.stringify(out, null, 2), "integraprojetos.json", "application/json");
}

function exportSVG(){
  const clone = svg.cloneNode(true);
  clone.setAttribute("xmlns","http://www.w3.org/2000/svg");
  clone.setAttribute("viewBox", `0 0 ${view.w} ${view.h}`);
  const ser = new XMLSerializer();
  downloadBlob(ser.serializeToString(clone), "integraprojetos.svg", "image/svg+xml");
}

function importJSONFile(ev){
  const f = ev.target.files[0];
  if(!f) return;
  const reader = new FileReader();
  reader.onload = () => {
    try{
      const obj = JSON.parse(reader.result);
      if(!obj.nodes || !obj.links) throw new Error("JSON sem nodes/links.");

      state = {
        meta: { app:"IntegraProjetos", version:1, updatedAt:new Date().toISOString() },
        nodes: obj.nodes.map(n => ({
          id: n.id || uid(),
          name: n.name || "Sem nome",
          level: n.level || "Graduação",
          area: n.area || "Clima & Saúde",
          title: n.title || "",
          objectives: n.objectives || "",
          expected: n.expected || "",
          tags: Array.isArray(n.tags) ? n.tags : [],
          color: n.color || "rgba(124,58,237,.95)",
          x: Number(n.x ?? (view.w/2 + (Math.random()-.5)*160)),
          y: Number(n.y ?? (view.h/2 + (Math.random()-.5)*160)),
          vx: 0, vy: 0, fx:null, fy:null
        })),
        links: obj.links.map(l => ({
          id: l.id || uid(),
          from: l.from, to: l.to,
          type: l.type || "dados",
          weight: Number(l.weight || 3),
          reason: l.reason || "",
          questions: l.questions || "",
          outputs: l.outputs || "",
          files: Array.isArray(l.files) ? l.files : []
        }))
      };

      selectedNodeId = null;
      persist();
      renderAll();
    }catch(err){
      alert("Falha ao importar: " + err.message);
    }finally{
      ev.target.value = "";
    }
  };
  reader.readAsText(f);
}

function resetAll(){
  if(!confirm("Resetar tudo e voltar ao modelo inicial?")) return;
  state = deepClone(SEED);
  initPositions(true);
  selectedNodeId = null;
  persist();
  renderAll();
}

/* ---- Drag ---- */
let dragging = null;

function getPointer(ev){
  const rect = svg.getBoundingClientRect();
  const isTouch = ev.touches && ev.touches[0];
  const clientX = isTouch ? ev.touches[0].clientX : ev.clientX;
  const clientY = isTouch ? ev.touches[0].clientY : ev.clientY;
  const x = (clientX - rect.left) * (view.w / rect.width);
  const y = (clientY - rect.top) * (view.h / rect.height);
  return { x, y };
}

function startDrag(ev, nodeId){
  ev.preventDefault();
  const pt = getPointer(ev);
  dragging = { id: nodeId, ox: pt.x, oy: pt.y };
  const n = getNode(nodeId);
  if(!n) return;
  n.fx = n.x; n.fy = n.y;

  window.addEventListener("mousemove", onDragMove);
  window.addEventListener("mouseup", onDragEnd);
  window.addEventListener("touchmove", onDragMove, {passive:false});
  window.addEventListener("touchend", onDragEnd);
}

function onDragMove(ev){
  if(!dragging) return;
  ev.preventDefault();
  const pt = getPointer(ev);
  const n = getNode(dragging.id);
  if(!n) return;
  n.fx = clamp(pt.x, 30, view.w - 30);
  n.fy = clamp(pt.y, 30, view.h - 30);
  renderGraph();
}

function onDragEnd(){
  if(!dragging) return;
  const n = getNode(dragging.id);
  if(n){
    n.x = n.fx; n.y = n.fy;
    n.fx = null; n.fy = null;
    persist();
  }
  dragging = null;
  window.removeEventListener("mousemove", onDragMove);
  window.removeEventListener("mouseup", onDragEnd);
  window.removeEventListener("touchmove", onDragMove);
  window.removeEventListener("touchend", onDragEnd);
}

/* ---- Simple sim ---- */
let sim = null;

function startSim(){
  if(sim) cancelAnimationFrame(sim);
  const step = () => {
    tick();
    renderGraph();
    sim = requestAnimationFrame(step);
  };
  sim = requestAnimationFrame(step);
}
function tick(){
  const centerPull = 0.0018;
  const repel = 9000;
  const linkK = 0.006;
  const damping = 0.92;

  state.nodes.forEach(n => {
    if(n.vx == null) n.vx = (Math.random()-.5)*0.8;
    if(n.vy == null) n.vy = (Math.random()-.5)*0.8;
  });

  for(let i=0;i<state.nodes.length;i++){
    for(let j=i+1;j<state.nodes.length;j++){
      const a=state.nodes[i], b=state.nodes[j];
      const dx=a.x-b.x, dy=a.y-b.y;
      let d2=dx*dx+dy*dy; if(d2<0.01) d2=0.01;
      const force=repel/d2;
      const d=Math.sqrt(d2);
      const fx=(dx/d)*force, fy=(dy/d)*force;
      if(a.fx==null){ a.vx += fx; a.vy += fy; }
      if(b.fx==null){ b.vx -= fx; b.vy -= fy; }
    }
  }

  state.links.forEach(l=>{
    const a=getNode(l.from), b=getNode(l.to);
    if(!a||!b) return;
    const dx=b.x-a.x, dy=b.y-a.y;
    const dist=Math.sqrt(dx*dx+dy*dy)||1;
    const target=180-(Number(l.weight||3)-3)*15;
    const k=linkK*Number(l.weight||3);
    const diff=(dist-target);
    const fx=(dx/dist)*diff*k;
    const fy=(dy/dist)*diff*k;
    if(a.fx==null){ a.vx += fx; a.vy += fy; }
    if(b.fx==null){ b.vx -= fx; b.vy -= fy; }
  });

  state.nodes.forEach(n=>{
    if(n.fx!=null && n.fy!=null){
      n.x=n.fx; n.y=n.fy;
      n.vx*=0.3; n.vy*=0.3;
      return;
    }
    const cx=view.w/2, cy=view.h/2;
    n.vx += (cx-n.x)*centerPull;
    n.vy += (cy-n.y)*centerPull;
    n.vx *= damping; n.vy *= damping;
    n.x = clamp(n.x + n.vx, 30, view.w-30);
    n.y = clamp(n.y + n.vy, 30, view.h-30);
  });
}

function bumpToCenter(id){
  const n=getNode(id); if(!n) return;
  n.vx += (view.w/2 - n.x) * 0.08;
  n.vy += (view.h/2 - n.y) * 0.08;
}

function autoNudge(){
  state.nodes.forEach(n => { n.vx += (Math.random()-.5)*6; n.vy += (Math.random()-.5)*6; });
}
</script>
</body>
</html>
